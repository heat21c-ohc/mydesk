<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart Dashboard V11 (Cloud Sync)</title>
    <style>
        :root {
            --primary-blue: #3b82f6; --dark-blue: #1e3a8a; --danger-red: #d32f2f;
            --soft-gray: #9ca3af; --dark-gray: #333333; --bg-color: #f3f4f6;
            --card-bg: #ffffff; --border-radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--dark-gray); margin: 0; padding: 15px; height: 100vh; overflow-y: auto; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 24px; color: var(--primary-blue); font-weight: 800; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .date-display { font-weight: 700; color: var(--dark-gray); margin-right: 10px; font-size: 15px; }
        .btn { border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-export { background-color: var(--primary-blue); }
        .btn-reset { background-color: var(--danger-red); }
        .btn-login { background-color: #4285F4; } /* Google Blue */
        .btn-logout { background-color: #757575; }

        .user-info { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; color: var(--dark-blue); }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }

        /* Login Overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
        .google-btn { margin-top: 20px; padding: 12px 24px; background: #4285F4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; justify-content: center; width: 100%; }
        .google-btn:hover { background: #357ae8; }

        /* 작은 버튼 스타일 */
        .btn-sm { padding: 4px 8px; font-size: 11px; background-color: #fff; color: var(--primary-blue); border: 1px solid var(--primary-blue); border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; transition: 0.2s; }
        .btn-sm:hover { background-color: var(--primary-blue); color: white; }

        /* Grid Layout */
        .container { display: grid; grid-template-columns: 28% 22% 48%; gap: 15px; min-height: 850px; height: calc(100vh - 100px); }
        .column { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 15px; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05); }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--soft-gray); text-transform: uppercase; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 8px; transition: color 0.3s; }
        .title-dark-blue { color: var(--dark-blue) !important; opacity: 1; }
        .title-red { color: var(--danger-red) !important; opacity: 1; }

        input[type="text"], textarea { width: 100%; border: 1px solid transparent; background: transparent; font-family: inherit; color: var(--dark-gray); font-size: 13px; padding: 4px; border-radius: 4px; resize: none; }
        ::placeholder { color: #d1d5db; opacity: 1; }
        input[type="text"]:focus, textarea:focus { outline: none; background: #f0f9ff; border-bottom: 1px solid var(--primary-blue); }
        .scroll-box { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Priority & ToDo */
        .priority-row { margin-bottom: 6px; border-bottom: 1px dashed #eee; height: 32px; display: flex; align-items: center; gap: 8px; }
        .priority-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--danger-red); flex-shrink: 0; }
        .priority-input { height: 100%; overflow-y: hidden; line-height: 20px; flex-grow: 1; }
        .priority-input:focus { overflow-y: auto; }
        
        .todo-block { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 6px; margin-bottom: 8px; }
        .todo-header { display: flex; gap: 4px; margin-bottom: 4px; border-bottom: 1px dashed #f0f0f0; padding-bottom: 4px;}
        .date-input { width: 50%; text-align: center; font-size: 11px; font-weight: bold; color: var(--soft-gray); cursor: context-menu; background: #f9fafb; border-radius: 4px; height: 22px; padding: 2px 0; }
        .date-input:focus { color: var(--dark-gray); background: #f0f9ff;}
        .todo-body { display: flex; align-items: flex-start; }
        .todo-chk-wrap { width: 22px; display: flex; justify-content: center; padding-top: 5px; }
        .todo-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--primary-blue); margin: 0;}
        .todo-content { flex-grow: 1; margin-left: 4px; height: 36px; min-height: 24px; overflow-y: auto; line-height: 1.4; }
        .todo-content.completed { text-decoration: line-through; color: #ccc; }
        
        .todo-content[readonly] { 
            color: #aaa; 
            cursor: default; 
        }

        /* Priority Selector Styles */
        .priority-wrap { 
            position: relative; 
            width: 26px; 
            height: 24px;
            display: flex; 
            justify-content: center; 
            align-items: center;
            margin-top: 2px;
            cursor: pointer;
            z-index: 10;
        }
        .priority-current { 
            font-size: 13px; 
            font-weight: bold;
            line-height: 1; 
            user-select: none;
            transition: transform 0.1s;
        }
        .priority-current:hover { transform: scale(1.1); }
        
        .priority-menu {
            display: none; 
            position: absolute; 
            top: 100%; 
            left: 0;
            background: white; 
            border: 1px solid #eee; 
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 100;
            width: 80px;
            overflow: hidden;
        }
        .priority-option { 
            padding: 8px 10px; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer; 
            color: #333;
            transition: background 0.1s;
        }
        .priority-option:hover { background: #f3f4f6; }
        
        /* Priority Colors */
        /* 업무:3(Blue), 교회:1(Purple), 개인:2(Green), 기타:0(Gray) */
        .prio-3 { color: #1e88e5; } 
        .prio-2 { color: #43a047; } 
        .prio-1 { color: #8e24aa; } 
        .prio-0 { color: #bdbdbd; }

        /* Time Line */
        .timeline-block { background: #f9fafb; border: 1px solid #eee; border-radius: 6px; padding: 6px; margin-bottom: 8px; }
        .timeline-header { display: flex; gap: 4px; margin-bottom: 4px; }
        .time-box { width: 50%; text-align: center; font-size: 11px; font-weight: bold; color: var(--soft-gray); cursor: context-menu; background: white; border: 1px solid #e5e7eb; border-radius: 4px; height: 22px; padding: 2px 0; }
        .time-box.filled { color: var(--dark-gray); border-color: var(--primary-blue); }
        .timeline-text { height: 40px; overflow-y: auto; }

        /* Rich Text Editor Styles */
        .editor-toolbar { display: flex; gap: 4px; padding: 4px 0; border-bottom: 1px solid #eee; margin-bottom: 5px; flex-wrap: wrap; background: #f9fafb; border-radius: 4px; }
        .editor-btn { border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px; padding: 2px 6px; font-size: 11px; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .editor-btn:hover { background: #f0f9ff; border-color: var(--primary-blue); }
        .editor-select { border: 1px solid #ddd; border-radius: 3px; font-size: 11px; padding: 2px; height: 24px; }
        .note-area-rich { flex-grow: 1; overflow-y: auto; border: 1px solid transparent; font-size: 13px; padding: 4px; border-radius: 4px; outline: none; line-height: 1.5; min-height: 100px; }
        .note-area-rich:focus { background: #f0f9ff; border-bottom: 1px solid var(--primary-blue); }
        .note-area-rich b { font-weight: bold; }
        .note-area-rich i { font-style: italic; }
        .note-area-rich u { text-decoration: underline; }
        .note-area-rich s { text-decoration: line-through; }

        /* Right Column Layout */
        .calendar-card { flex: 1.5; min-height: 200px; padding: 10px; display: flex; flex-direction: column; }
        .note-card { flex: 1; min-height: 150px; display: flex; flex-direction: column; }
        .sp-card { flex: 0.8; }
        .sum-card { flex: 0.8; }
        
        .calendar-wrapper { 
            flex-grow: 1; 
            width: 100%; 
            position: relative; 
            overflow: hidden; 
            border-radius: 8px; 
            border: 1px solid #eee;
        }
        iframe { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; 
            height: 100%; 
            border: 0; 
        }

        /* Sp & Sum */
        .sp-grid { display: flex; gap: 8px; height: 100%; }
        .sp-item { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .sp-label { font-size: 11px; text-align: center; color: white; margin-bottom: 5px; font-weight: bold; flex: 0 0 auto; border-radius: 12px; padding: 3px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-purple { background-color: #8e24aa; }
        .sp-text { flex-grow: 1; border: 1px solid #e5e7eb; border-radius: 6px; background: #fff; font-size: 12px; overflow-y: auto; padding: 6px; }
        .sum-grid { display: flex; gap: 10px; height: 100%; }
        .sum-item { flex: 1; display: flex; flex-direction: column; border-radius: 6px; padding: 8px; height: 100%; border: 1px solid rgba(0,0,0,0.05); }
        .sum-item.thanks { background: #fffbeb; }
        .sum-item.summary { background: #eff6ff; }
        .sum-label { font-size: 12px; font-weight: 800; text-align: center; color: #555; margin-bottom: 5px; flex: 0 0 auto; }
        .sum-text { flex-grow: 1; border: 1px solid #e0e0e0; border-radius: 6px; background: white; overflow-y: auto; resize: none; font-size: 12px; padding: 6px; }

        /* Modal & Context Menu */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 300px; }
        .chk-list label { display: block; margin: 10px 0; cursor: pointer; color: var(--dark-gray); }
        .modal-btns { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        #ctxMenu { display: none; position: absolute; background: white; border: 1px solid #ddd; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 6px; z-index: 2000; min-width: 120px; }
        #ctxMenu div { padding: 8px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        #ctxMenu div:last-child { border-bottom: none; }
        #ctxMenu div:hover { background: #f3f4f6; }
        
        /* Save Status Indicator */
        #saveStatus { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            body { padding: 10px; height: auto; overflow-y: auto; }
            .container { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .card { min-height: auto; }
            
            .calendar-card { min-height: 600px !important; flex: auto; }
            
            /* [수정] Note 카드 높이 고정 및 내부 스크롤 강제 */
            .note-card { 
                height: 400px !important; 
                min-height: 400px; 
                flex: none; 
                display: flex; 
                flex-direction: column; 
            }
            .note-card .note-area-rich {
                flex-grow: 1;
                height: 0; /* 부모 높이 내에서 스크롤 생성용 */
                min-height: 0;
                overflow-y: auto;
            }
            
            .sp-card, .sum-card { min-height: auto; flex: auto; }
            .sp-grid, .sum-grid { flex-direction: column; height: auto; gap: 15px; }
            .sp-item, .sum-item { height: auto; min-height: 180px; }
            .sp-text, .sum-text { min-height: 140px; }

            header { flex-direction: column; align-items: flex-start; }
            .controls { width: 100%; justify-content: space-between; margin-top: 10px; }
        }
    </style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
    <div class="login-card">
        <h2 style="color:var(--dark-blue); margin-bottom:10px;">My Cloud Dashboard</h2>
        <p style="color:#666; font-size:14px; margin-bottom:30px;">
            PC와 스마트폰에서 데이터를<br>동기화하기 위해 로그인하세요.
        </p>
        <button class="google-btn" onclick="googleLogin()">
            <!-- Google Icon SVG -->
            <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#fff" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#fff" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#fff" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
            구글 계정으로 로그인
        </button>
        <div style="margin-top:20px; font-size:11px; color:#999; text-align:left; background:#f9fafb; padding:10px; border-radius:8px;">
            <b>[필수 설정]</b><br>
            이 파일의 코드 하단 스크립트 영역에<br>본인의 Firebase Config 값을 입력해야 작동합니다.
        </div>
    </div>
</div>

<header>
    <h1>My Dashboard</h1>
    <div class="controls">
        <span class="date-display" id="headerDate">Loading...</span>
        <div id="userInfo" class="user-info" style="display:none;">
            <img id="userImg" class="user-avatar" src="">
            <span id="userName">User</span>
        </div>
        <button class="btn btn-logout" onclick="logout()" style="display:none;" id="btnLogout">로그아웃</button>
        <button class="btn btn-export" onclick="exportData()">내보내기</button>
        <button class="btn btn-reset" onclick="openResetModal()">지우기</button>
    </div>
</header>

<div class="container">
    <!-- Left Column -->
    <div class="column">
        <div class="card" style="flex: 0 0 auto;">
            <div class="section-title title-red">Top Priority 3</div>
            <div id="priorityBox">
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="1. 우선순위 입력"></textarea>
                </div>
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="2. 우선순위 입력"></textarea>
                </div>
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="3. 우선순위 입력"></textarea>
                </div>
            </div>
        </div>
        <div class="card" style="flex: 1 1 auto;">
            <div class="section-title title-dark-blue">To Do List</div>
            <div class="scroll-box" id="todoBox"></div>
        </div>
    </div>
    
    <!-- Middle Column -->
    <div class="column">
        <div class="card" style="height: 100%;">
            <div class="section-title title-dark-blue">Time Line</div>
            <div class="scroll-box" id="timelineBox"></div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="column">
        <div class="card calendar-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px;">
                <div class="section-title title-dark-blue" style="margin: 0; border: none; padding: 0;">Calendar</div>
                <a href="https://calendar.google.com" target="_blank" class="btn-sm">일정 관리 ↗</a>
            </div>
            <div class="calendar-wrapper">
                <!-- iframe에 id 추가: calendarFrame -->
                <iframe id="calendarFrame" src="https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>

        <div class="card note-card">
            <div class="section-title title-dark-blue">Note</div>
            <!-- Editor Toolbar -->
            <div class="editor-toolbar">
                <select class="editor-select" onchange="formatDoc('fontSize', this.value); this.value='';">
                    <option value="" selected disabled>크기</option>
                    <option value="2">작게</option>
                    <option value="3">보통</option>
                    <option value="5">크게</option>
                </select>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('bold')" title="굵게"><b>B</b></button>
                <button class="editor-btn" onclick="formatDoc('italic')" title="기울기"><i>I</i></button>
                <button class="editor-btn" onclick="formatDoc('underline')" title="밑줄"><u>U</u></button>
                <button class="editor-btn" onclick="formatDoc('strikeThrough')" title="가운데줄"><s>S</s></button>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#333333')" title="검정색" style="color:black; font-weight:bold;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#d32f2f')" title="빨강색" style="color:#d32f2f; font-weight:bold;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#3b82f6')" title="파랑색" style="color:#3b82f6; font-weight:bold;">A</button>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('justifyLeft')" title="좌측정렬">좌</button>
                <button class="editor-btn" onclick="formatDoc('justifyCenter')" title="가운데정렬">중</button>
                <button class="editor-btn" onclick="formatDoc('justifyRight')" title="우측정렬">우</button>
            </div>
            <div class="note-area-rich" id="mainNote" contenteditable="true" placeholder="메모를 입력하세요..."></div>
        </div>

        <div class="card sp-card">
            <div class="section-title title-dark-blue">경건생활</div>
            <div class="sp-grid">
                <div class="sp-item"><span class="sp-label bg-green">실천</span><textarea class="sp-text" id="sp1"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-orange">반성</span><textarea class="sp-text" id="sp2"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-purple">소망</span><textarea class="sp-text" id="sp3"></textarea></div>
            </div>
        </div>
        <div class="card sum-card">
            <div class="sum-grid">
                <div class="sum-item thanks"><span class="sum-label">THANKS GOD</span><textarea class="sum-text" id="thanksText"></textarea></div>
                <div class="sum-item summary"><span class="sum-label">SUMMARY</span><textarea class="sum-text" id="summaryText"></textarea></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="resetModal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--dark-gray);">항목 지우기</h3>
        <div class="chk-list">
            <label><input type="checkbox" id="chkPri" checked> Top Priority</label>
            <label><input type="checkbox" id="chkTodo" checked> To Do List</label>
            <label><input type="checkbox" id="chkTime" checked> Time Line</label>
            <label><input type="checkbox" id="chkNote" checked> Note & Others</label>
        </div>
        <div class="modal-btns">
            <button class="btn" style="background:#ddd; color:#333" onclick="closeResetModal()">취소</button>
            <button class="btn btn-reset" onclick="executeReset()">삭제</button>
        </div>
    </div>
</div>

<!-- Context Menu Update -->
<div id="ctxMenu">
    <div id="ctxItemInsert" onclick="handleCtx('insert')">입력</div>
    <div id="ctxItemManual" onclick="handleCtx('manual')">수동입력</div> 
    <div id="ctxItemClear" onclick="handleCtx('clear')">지우기</div>
</div>

<div id="saveStatus">저장됨</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // -------------------------------------------------------------
    // [중요] Firebase 콘솔에서 복사한 Config 값을 아래에 붙여넣으세요.
    // -------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDNq4dpGtd7RPH6Gey9V4hH6FwdPkLEavs",
        authDomain: "mydashboard-ohc.firebaseapp.com",
        projectId: "mydashboard-ohc",
        storageBucket: "mydashboard-ohc.firebasestorage.app",
        messagingSenderId: "802535259250",
        appId: "1:802535259250:web:48f21568b7c735a2ec16eb",
        measurementId: "G-9NZGEZ4KBF"
    };

    // Initialize Firebase
    let app, auth, db, currentUser;
    let unsubscribeSnapshot = null;
    let isRemoteUpdate = false; // Flag to prevent saving when receiving data

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase Init Error (Config 확인 필요):", e);
    }

    // --- Auth Functions (Enhanced Error Handling) ---
    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch((error) => {
            console.error("Login Error:", error);
            
            let msg = "로그인 실패: " + error.message;
            
            // Check for specific Firebase error codes
            if (error.code === 'auth/operation-not-allowed') {
                msg = "설정 오류: Google 로그인이 꺼져 있습니다.\nFirebase 콘솔 > Authentication > Sign-in method 에서 Google을 '사용 설정' 해주세요.";
            } else if (error.code === 'auth/unauthorized-domain') {
                msg = "도메인 오류: 현재 주소가 승인되지 않았습니다.\nFirebase 콘솔 > Authentication > Settings > 승인된 도메인에 현재 도메인(IP)을 추가하세요.";
            } else if (window.location.protocol === 'file:') {
                msg = "실행 환경 오류: 보안상 HTML 파일을 더블클릭해서 열면 로그인이 안 됩니다.\n\n[해결법]\n1. VS Code의 'Live Server' 확장프로그램 사용 (추천)\n2. 또는 웹 호스팅(GitHub Pages 등)에 올려서 접속";
            }

            alert(msg);
        });
    };

    window.logout = () => {
        if(confirm("로그아웃 하시겠습니까?")) {
            signOut(auth);
        }
    };

    // --- Sync Logic ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            // UI Update
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('btnLogout').style.display = 'block';
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;

            // [추가된 기능] 캘린더 자동 업데이트 (사용자 이메일 기반)
            const calFrame = document.getElementById('calendarFrame');
            if(user.email) {
                // 이메일에 특수문자가 있을 수 있으므로 인코딩
                const encodedEmail = encodeURIComponent(user.email);
                calFrame.src = `https://calendar.google.com/calendar/embed?src=${encodedEmail}&ctz=Asia%2FSeoul`;
            }
            
            // Start Sync
            const docRef = doc(db, "dashboards", user.uid);
            
            // Realtime Listener
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    isRemoteUpdate = true; // Block auto-save loop
                    applyDataToUI(docSnap.data());
                    isRemoteUpdate = false;
                } else {
                    // No data yet, try loading from local storage as backup or init empty
                    console.log("No remote data, starting fresh.");
                }
            });

        } else {
            currentUser = null;
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('btnLogout').style.display = 'none';

            // 로그아웃 시 기본 달력(휴일)으로 복구
            const calFrame = document.getElementById('calendarFrame');
            calFrame.src = "https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul";
        }
    });

    // --- Debounced Save ---
    let saveTimeout;
    window.triggerSave = () => {
        if(!currentUser || isRemoteUpdate) return;

        // Show "Saving..." or similar if desired
        const status = document.getElementById('saveStatus');
        status.innerText = "저장 중...";
        status.style.opacity = 1;

        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveToCloud();
        }, 1000); // Wait 1 sec after typing stops
    };

    async function saveToCloud() {
        if(!currentUser) return;
        const data = collectDataFromUI();
        
        try {
            await setDoc(doc(db, "dashboards", currentUser.uid), data, { merge: true });
            const status = document.getElementById('saveStatus');
            status.innerText = "동기화 완료";
            setTimeout(()=> { status.style.opacity = 0; }, 2000);
        } catch (e) {
            console.error("Save Error:", e);
            document.getElementById('saveStatus').innerText = "저장 실패";
        }
    }

    // Expose functions needed globally
    window.appSave = window.triggerSave; 
    window.forceSave = saveToCloud; 

</script>

<script>
    // --- Local UI & Logic ---
    let ctxTarget = null;
    let ctxType = null;

    // --- [중요 수정] DOM 로드 대기 ---
    // script가 실행될 때 아직 HTML 요소가 생성되지 않았을 수 있으므로
    // DOMContentLoaded 이벤트를 사용하여 확실하게 로드된 후 실행합니다.
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
    });

    function initApp() {
        // [수정] headerDate가 존재하는지 확인 후 실행
        const headerDate = document.getElementById('headerDate');
        if (headerDate) {
            const now = new Date();
            headerDate.innerText = now.toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });
        }

        // 렌더링 함수 즉시 실행
        renderTodo(15);
        renderTimeline(15);

        // Add Listeners
        document.body.addEventListener('input', (e) => {
            if(window.appSave) window.appSave();
        });
        document.body.addEventListener('change', (e) => {
            if(window.appSave) window.appSave();
        });
        // Rich text specific listener
        const mainNote = document.getElementById('mainNote');
        if (mainNote) {
            mainNote.addEventListener('input', (e) => {
                 if(window.appSave) window.appSave();
            });
        }
        
        document.addEventListener('click', (e) => {
            const ctxMenu = document.getElementById('ctxMenu');
            if (ctxMenu) ctxMenu.style.display = 'none';
            // 중요도 메뉴도 닫기
            if (!e.target.closest('.priority-wrap')) {
                document.querySelectorAll('.priority-menu').forEach(m => m.style.display = 'none');
            }
        });
    };

    // --- Data Handling (Separated for Sync) ---
    function collectDataFromUI() {
        // [수정] Priority 체크 상태 수집 포함
        const priRows = Array.from(document.querySelectorAll('#priorityBox .priority-row'));
        const priData = priRows.map(r => ({
            t: r.querySelector('textarea').value,
            c: r.querySelector('input[type="checkbox"]').checked
        }));

        return {
            pri: priData, // 이제 문자열 배열이 아니라 객체 배열입니다.
            todo: Array.from(document.querySelectorAll('.todo-block')).map(r => ({
                s: r.querySelector('.t-start').value,
                e: r.querySelector('.t-end').value,
                c: r.querySelector('.todo-check').checked,
                p: r.querySelector('.priority-current').getAttribute('data-val') || '0',
                t: r.querySelector('.todo-content').value
            })),
            line: Array.from(document.querySelectorAll('.timeline-block')).map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            })),
            note: document.getElementById('mainNote').innerHTML,
            sp: [document.getElementById('sp1').value, document.getElementById('sp2').value, document.getElementById('sp3').value],
            sum: [document.getElementById('thanksText').value, document.getElementById('summaryText').value]
        };
    }

    function applyDataToUI(d) {
        if(!d) return;

        const safeVal = (el, val) => {
            if(el && el !== document.activeElement && el.value !== val) {
                el.value = val;
            }
        };

        // [수정] Priority 데이터 적용 (객체 배열 또는 구버전 문자열 배열 호환)
        const priRows = document.querySelectorAll('#priorityBox .priority-row');
        if(d.pri && Array.isArray(d.pri)) {
            d.pri.forEach((v, i) => {
                if(priRows[i]) {
                    const txt = typeof v === 'object' ? v.t : v;
                    const chk = typeof v === 'object' ? v.c : false;
                    safeVal(priRows[i].querySelector('textarea'), txt);
                    priRows[i].querySelector('input[type="checkbox"]').checked = chk;
                }
            });
        }

        // ... 기존 applyDataToUI 코드 ...
        const tBlocks = document.querySelectorAll('.todo-block');
        if(d.todo) d.todo.forEach((v,i) => {
            if(tBlocks[i]) {
                safeVal(tBlocks[i].querySelector('.t-start'), v.s);
                safeVal(tBlocks[i].querySelector('.t-end'), v.e);
                
                const chk = tBlocks[i].querySelector('.todo-check');
                if(chk.checked !== v.c) {
                    chk.checked = v.c;
                    const content = tBlocks[i].querySelector('.todo-content');
                    if(v.c) {
                        content.classList.add('completed');
                        content.readOnly = true;
                    } else {
                        content.classList.remove('completed');
                        content.readOnly = false;
                    }
                }
                
                const prioEl = tBlocks[i].querySelector('.priority-current');
                if(prioEl) {
                    const savedP = v.p || '0';
                    if (prioEl.getAttribute('data-val') !== savedP) {
                        updatePriorityUI(prioEl, savedP);
                    }
                }

                safeVal(tBlocks[i].querySelector('.todo-content'), v.t);
            }
        });

        const lBlocks = document.querySelectorAll('.timeline-block');
        if(d.line) d.line.forEach((v,i) => {
            if(lBlocks[i]) {
                const s = lBlocks[i].querySelector('.tm-start');
                const e = lBlocks[i].querySelector('.tm-end');
                safeVal(s, v.s);
                safeVal(e, v.e);
                if(v.s) s.classList.add('filled'); else s.classList.remove('filled');
                if(v.e) e.classList.add('filled'); else e.classList.remove('filled');
                safeVal(lBlocks[i].querySelector('.timeline-text'), v.t);
            }
        });

        const noteDiv = document.getElementById('mainNote');
        if(d.note && noteDiv.innerHTML !== d.note && document.activeElement !== noteDiv) {
            noteDiv.innerHTML = d.note;
        }
        
        safeVal(document.getElementById('sp1'), d.sp[0]||''); 
        safeVal(document.getElementById('sp2'), d.sp[1]||'');
        safeVal(document.getElementById('sp3'), d.sp[2]||'');
        safeVal(document.getElementById('thanksText'), d.sum[0]||'');
        safeVal(document.getElementById('summaryText'), d.sum[1]||'');
    }

    // --- Original Logic Functions ---
    function formatDoc(cmd, value=null) {
        if(value) document.execCommand(cmd, false, value);
        else document.execCommand(cmd);
        document.getElementById('mainNote').focus();
        if(window.appSave) window.appSave();
    }

    // [수정됨] ToDo 렌더링 함수: 중요도 선택기 순서 변경 (업무-교회-개인-기타)
    function renderTodo(count) {
        const box = document.getElementById('todoBox');
        let html = '';
        for(let i=0; i<count; i++) {
            html += `
            <div class="todo-block">
                <div class="todo-header">
                    <input type="text" class="date-input t-start" placeholder="시작" readonly 
                           onclick="handleDateClick(this)"
                           onkeydown="handleInputKey(event, this, 'date-kr')"
                           oncontextmenu="openCtx(event, this, 'reset-only')">
                    <input type="text" class="date-input t-end" placeholder="마침" readonly>
                </div>
                <div class="todo-body">
                    <div class="todo-chk-wrap">
                        <input type="checkbox" class="todo-check" onchange="toggleTodo(this)">
                    </div>
                    
                    <!-- [수정] 중요도 메뉴 순서 변경: 업무 -> 교회 -> 개인 -> 기타 -->
                    <div class="priority-wrap" onclick="togglePrio(this)">
                        <div class="priority-current prio-0" data-val="0">기</div>
                        <div class="priority-menu">
                            <div class="priority-option prio-3" onclick="setPrio(event, this, '3')">업무</div>
                            <div class="priority-option prio-1" onclick="setPrio(event, this, '1')">교회</div>
                            <div class="priority-option prio-2" onclick="setPrio(event, this, '2')">개인</div>
                            <div class="priority-option prio-0" onclick="setPrio(event, this, '0')">기타</div>
                        </div>
                    </div>

                    <textarea class="todo-content" placeholder="할 일 입력"></textarea>
                </div>
            </div>`;
        }
        box.innerHTML = html;
    }

    function togglePrio(wrapper) {
        const menu = wrapper.querySelector('.priority-menu');
        document.querySelectorAll('.priority-menu').forEach(m => {
            if(m !== menu) m.style.display = 'none';
        });
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    function setPrio(e, el, val) {
        e.stopPropagation(); 
        const wrapper = el.closest('.priority-wrap');
        const current = wrapper.querySelector('.priority-current');
        updatePriorityUI(current, val);
        wrapper.querySelector('.priority-menu').style.display = 'none';
        if(window.appSave) window.appSave();
    }

    function updatePriorityUI(el, val) {
        el.setAttribute('data-val', val);
        el.className = 'priority-current'; 
        el.classList.add('prio-' + val);
        
        // [수정] 표시 텍스트 순서 및 매핑 (데이터 호환성 유지)
        // 3:업무, 1:교회, 2:개인, 0:기타
        switch(val) {
            case '3': el.innerText = '업'; break;
            case '1': el.innerText = '교'; break;
            case '2': el.innerText = '개'; break;
            default:  el.innerText = '기'; break;
        }
    }

    function renderTimeline(count) {
        const box = document.getElementById('timelineBox');
        let html = '';
        for(let i=0; i<count; i++) {
            html += `
            <div class="timeline-block">
                <div class="timeline-header">
                    <input type="text" class="time-box tm-start" placeholder="시작" readonly 
                           onclick="handleTimeClick(this)" 
                           onkeydown="handleInputKey(event, this, 'time-kr')" 
                           oncontextmenu="openCtx(event, this, 'time-menu')">
                    <input type="text" class="time-box tm-end" placeholder="마침" readonly 
                           onclick="handleTimeClick(this)" 
                           onkeydown="handleInputKey(event, this, 'time-kr')" 
                           oncontextmenu="openCtx(event, this, 'time-menu')">
                </div>
                <textarea class="timeline-text" placeholder="내용"></textarea>
            </div>`;
        }
        box.innerHTML = html;
    }

    // [수정됨] 새로운 날짜/시간 포맷 함수
    function getFormattedDateTime() {
        const now = new Date();
        const yy = now.getFullYear().toString().slice(-2);
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const dd = now.getDate().toString().padStart(2, '0');
        const hh = now.getHours().toString().padStart(2, '0');
        const mi = now.getMinutes().toString().padStart(2, '0');
        return `${yy}년${mm}월${dd}일${hh}시${mi}분`;
    }

    // [수정됨] 수동 입력 파싱 로직 업데이트
    function parseDateTimeInput(input) {
        const now = new Date();
        let yy = now.getFullYear().toString().slice(-2);
        let mm = (now.getMonth() + 1).toString().padStart(2, '0');
        let dd = now.getDate().toString().padStart(2, '0');
        let hh = now.getHours().toString().padStart(2, '0');
        let mi = now.getMinutes().toString().padStart(2, '0');

        const nums = input.replace(/[^0-9]/g, '');
        
        if (nums.length === 10) {
            // YYMMDDHHMM
            yy = nums.slice(0, 2);
            mm = nums.slice(2, 4);
            dd = nums.slice(4, 6);
            hh = nums.slice(6, 8);
            mi = nums.slice(8, 10);
        } else if (nums.length === 4) {
            // HHMM (Date remains today)
            hh = nums.slice(0, 2);
            mi = nums.slice(2, 4);
        } else if (nums.length === 3) {
            // HMM (e.g. 446 -> 04:46)
            hh = nums.slice(0, 1).padStart(2, '0');
            mi = nums.slice(1, 3);
        } else if (input.includes('-')) {
            // Check for H-MM or HH-MM
            const parts = input.split('-');
            if(parts.length === 2) {
                 hh = parts[0].padStart(2, '0');
                 mi = parts[1].padStart(2, '0');
            }
        } else {
            return null;
        }

        return `${yy}년${mm}월${dd}일${hh}시${mi}분`;
    }

    function handleDateClick(el) {
        // [수정] Todo 시작일 클릭시에도 전체 포맷 적용 (이전에는 월일만)
        el.value = getFormattedDateTime();
        if(window.appSave) window.appSave();
    }

    function handleTimeClick(el) {
        el.value = getFormattedDateTime();
        el.classList.add('filled');
        if(window.appSave) window.appSave();
    }

    function handleInputKey(e, el, type) {
        if(e.key === 'Enter') {
            e.preventDefault();
            // 모든 날짜/시간 입력에서 동일한 포맷 사용
            el.value = getFormattedDateTime();
            if(type === 'time-kr') el.classList.add('filled');
            if(window.appSave) window.appSave();
        }
    }

    function toggleTodo(chk) {
        const block = chk.closest('.todo-block');
        const end = block.querySelector('.t-end');
        const txt = block.querySelector('.todo-content');
        if(chk.checked) {
            end.value = getFormattedDateTime(); // [수정] 완료 시에도 동일 포맷
            txt.classList.add('completed');
            txt.readOnly = true; 
        } else {
            end.value = '';
            txt.classList.remove('completed');
            txt.readOnly = false; 
        }
        if(window.appSave) window.appSave();
    }

    function openCtx(e, el, type) {
        e.preventDefault();
        ctxTarget = el;
        ctxType = type;
        const menu = document.getElementById('ctxMenu');
        const itemInsert = document.getElementById('ctxItemInsert');
        const itemManual = document.getElementById('ctxItemManual');
        const itemClear = document.getElementById('ctxItemClear');

        // 기본값 숨김
        itemInsert.style.display = 'none';
        itemManual.style.display = 'none';
        itemClear.innerText = '지우기';

        // 타입별 메뉴 구성
        if (type === 'reset-only') {
            itemClear.innerText = '초기화';
            // To Do 시작일에서 수동 입력 추가 요청 반영
            itemManual.style.display = 'block'; 
        } else if (type === 'time-menu') {
            itemManual.style.display = 'block'; 
            itemClear.innerText = '초기화';
        } else if (type === 'todo-start-menu') { // (예비용)
             itemManual.style.display = 'block';
             itemClear.innerText = '초기화';
        } else {
            itemInsert.style.display = 'block';
            itemInsert.innerText = "오늘 날짜 입력";
        }

        menu.style.display = 'block';
        
        let x = e.pageX;
        let y = e.pageY;
        if(x + 120 > window.innerWidth) x -= 120;
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }

    function handleCtx(action) {
        if(!ctxTarget) return;
        
        if (action === 'manual') {
            const input = prompt("시간을 입력하세요 (예: 2512091648, 12-11, 1648)");
            if (input) {
                const formattedTime = parseDateTimeInput(input); // [수정] 새 파싱 함수 사용
                if (formattedTime) {
                    ctxTarget.value = formattedTime;
                    ctxTarget.classList.add('filled');
                } else {
                    alert("올바른 형식이 아닙니다.");
                }
            }
        } else if (action === 'insert') {
            ctxTarget.value = getFormattedDateTime();
        } else {
            ctxTarget.value = '';
            ctxTarget.classList.remove('filled');
        }
        
        if(window.appSave) window.appSave();
        document.getElementById('ctxMenu').style.display = 'none'; 
    }

    function openResetModal() { document.getElementById('resetModal').style.display='flex'; }
    function closeResetModal() { document.getElementById('resetModal').style.display='none'; }
    
    function executeReset() {
        if(document.getElementById('chkPri').checked) {
            document.querySelectorAll('#priorityBox .priority-row').forEach(row => {
                row.querySelector('textarea').value = '';
                row.querySelector('input[type="checkbox"]').checked = false;
            });
        }
        if(document.getElementById('chkTime').checked) {
            document.querySelectorAll('.timeline-block input').forEach(e=> { e.value=''; e.classList.remove('filled'); });
            document.querySelectorAll('.timeline-block textarea').forEach(e=>e.value='');
        }
        if(document.getElementById('chkNote').checked) {
            document.getElementById('mainNote').innerHTML = '';
            ['sp1','sp2','sp3','thanksText','summaryText'].forEach(id=>document.getElementById(id).value='');
        }
        if(document.getElementById('chkTodo').checked) {
            const blocks = document.querySelectorAll('.todo-block');
            blocks.forEach(r => {
                r.querySelector('.t-start').value=''; r.querySelector('.t-end').value='';
                r.querySelector('.todo-check').checked=false; r.querySelector('.todo-content').value='';
                r.querySelector('.todo-content').classList.remove('completed');
                r.querySelector('.todo-content').readOnly = false;
                const p = r.querySelector('.priority-current');
                if(p) updatePriorityUI(p, '0');
            });
        }
        if(window.appSave) window.appSave();
        closeResetModal();
    }

    function exportData() {
        // [중요] 새로 배포한 구글 앱스 스크립트 URL을 여기에 넣으세요
        const scriptURL = "https://script.google.com/macros/s/AKfycbxX3gDWPWkeL4F6A7LVnyH1Ti6QueDJLjbDzO4e2ro4_nNkaX9JQc5m2JNNRNZM53je/exec"; 

        if(!scriptURL || scriptURL === "여기에_구글_웹앱_URL_붙여넣기") {
            alert("코드를 수정하여 'scriptURL' 변수에 구글 앱스 스크립트 배포 주소를 입력해주세요!");
            return;
        }

        if(!confirm("체크된 항목만 내보내고 화면을 정리하시겠습니까?")) return;

        const btn = document.querySelector('.btn-export');
        const originalText = btn.innerText;
        btn.innerText = "전송 중...";

        // [수정] 중요도 매핑 함수 (숫자 -> 텍스트, 순서 정리)
        const getPrioText = (val) => {
            if(val === '3') return '업무';
            if(val === '1') return '교회';
            if(val === '2') return '개인';
            return '기타';
        };

        // 1. 데이터 분류
        const allBlockEls = Array.from(document.querySelectorAll('.todo-block'));
        const allTodosRaw = allBlockEls.map(r => ({
            s: r.querySelector('.t-start').value,
            e: r.querySelector('.t-end').value,
            c: r.querySelector('.todo-check').checked,
            p_val: r.querySelector('.priority-current').getAttribute('data-val') || '0', 
            t: r.querySelector('.todo-content').value
        }));

        const exportTodos = allTodosRaw
            .filter(t => t.c === true)
            .map(t => ({
                s: t.s,
                e: t.e,
                c: t.c,
                p: getPrioText(t.p_val), 
                t: t.t
            }));
        
        const keptTodos = allTodosRaw.filter(t => t.c === false && t.t.trim() !== "");

        // 3. TimeLine Data
        const timelineData = Array.from(document.querySelectorAll('.timeline-block'))
            .map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            }))
            .filter(l => l.t.trim() !== ""); 

        const payload = {
            pri: Array.from(document.querySelectorAll('#priorityBox textarea')).map(e=>e.value),
            todo: exportTodos, 
            line: timelineData, 
            note: document.getElementById('mainNote').innerText,
            sp: [
                document.getElementById('sp1').value, 
                document.getElementById('sp2').value, 
                document.getElementById('sp3').value
            ],
            sum: [
                document.getElementById('thanksText').value, 
                document.getElementById('summaryText').value
            ]
        };

        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success') {
                alert("성공적으로 저장되었습니다!\n각 항목이 개별 행으로 입력됩니다.");
                resetAndRestore(keptTodos);
            } else {
                alert("전송 실패: " + data.error);
            }
        })
        .catch(error => {
            console.error('Export Error:', error);
            alert("전송 요청 완료! (데이터가 시트에 들어갔는지 확인하세요)\n화면을 정리합니다.");
            resetAndRestore(keptTodos);
        })
        .finally(() => {
            btn.innerText = originalText;
        });
    }

    function resetAndRestore(keptTodos) {
        // A. 초기화
        const priRows = document.querySelectorAll('#priorityBox .priority-row');
        priRows.forEach(r => {
            r.querySelector('textarea').value = '';
            r.querySelector('input[type="checkbox"]').checked = false;
        });

        document.querySelectorAll('.timeline-block input').forEach(e => { e.value = ''; e.classList.remove('filled'); });
        document.querySelectorAll('.timeline-block textarea').forEach(e => e.value = '');
        document.getElementById('mainNote').innerHTML = '';
        ['sp1', 'sp2', 'sp3', 'thanksText', 'summaryText'].forEach(id => document.getElementById(id).value = '');

        const blocks = document.querySelectorAll('.todo-block');
        blocks.forEach(r => {
            r.querySelector('.t-start').value = '';
            r.querySelector('.t-end').value = '';
            r.querySelector('.todo-check').checked = false;
            r.querySelector('.todo-content').value = '';
            r.querySelector('.todo-content').classList.remove('completed');
            r.querySelector('.todo-content').readOnly = false; 
            const p = r.querySelector('.priority-current');
            if(p) updatePriorityUI(p, '0'); 
        });

        // B. ToDo 복구
        keptTodos.forEach((item, index) => {
            if(blocks[index]) {
                blocks[index].querySelector('.t-start').value = item.s;
                blocks[index].querySelector('.t-end').value = item.e; 
                blocks[index].querySelector('.todo-content').value = item.t;
                
                const p = blocks[index].querySelector('.priority-current');
                if(p) updatePriorityUI(p, item.p_val);
            }
        });

        if(window.forceSave) window.forceSave(); 
    }
</script>
</body>
</html>

