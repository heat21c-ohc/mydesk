<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart Dashboard V12 (Upgraded)</title>
    <style>
        :root {
            /* Light Theme Variables */
            --primary-blue: #3b82f6; 
            --dark-blue: #1e3a8a; 
            --danger-red: #d32f2f;
            --soft-gray: #9ca3af; 
            --dark-gray: #333333; 
            --bg-color: #f3f4f6;
            --card-bg: #ffffff; 
            --text-color: #333333;
            --border-color: #eee;
            --input-bg: transparent;
            --input-focus-bg: #f0f9ff;
            --border-radius: 12px; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --progress-bg: #e5e7eb;
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --primary-blue: #60a5fa;
            --dark-blue: #93c5fd;
            --danger-red: #ef5350;
            --soft-gray: #9ca3af;
            --dark-gray: #e5e7eb;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f3f4f6;
            --border-color: #374151;
            --input-bg: #374151;
            --input-focus-bg: #4b5563;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --progress-bg: #374151;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; height: 100vh; overflow-y: auto; transition: background 0.3s, color 0.3s; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; flex-wrap: wrap; gap: 10px; transition: background 0.3s; }
        h1 { margin: 0; font-size: 24px; color: var(--primary-blue); font-weight: 800; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .date-display { font-weight: 700; color: var(--text-color); margin-right: 10px; font-size: 15px; }
        .btn { border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-export { background-color: var(--primary-blue); }
        .btn-reset { background-color: var(--danger-red); }
        .btn-theme { background-color: var(--dark-gray); } /* Dark Mode Toggle */
        .btn-logout { background-color: #757575; }

        .user-info { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; color: var(--dark-blue); }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }

        /* Login Overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
        .google-btn { margin-top: 20px; padding: 12px 24px; background: #4285F4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; justify-content: center; width: 100%; }
        .google-btn:hover { background: #357ae8; }

        /* ÏûëÏùÄ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .btn-sm { padding: 4px 8px; font-size: 11px; background-color: transparent; color: var(--primary-blue); border: 1px solid var(--primary-blue); border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; transition: 0.2s; }
        .btn-sm:hover { background-color: var(--primary-blue); color: white; }

        /* Grid Layout */
        .container { display: grid; grid-template-columns: 28% 22% 48%; gap: 15px; min-height: 850px; height: calc(100vh - 100px); }
        .column { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--soft-gray); text-transform: uppercase; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-bottom: 8px; transition: color 0.3s; }
        .title-dark-blue { color: var(--dark-blue) !important; opacity: 1; }
        .title-red { color: var(--danger-red) !important; opacity: 1; }

        input[type="text"], textarea { width: 100%; border: 1px solid transparent; background: transparent; font-family: inherit; color: var(--text-color); font-size: 13px; padding: 4px; border-radius: 4px; resize: none; }
        ::placeholder { color: var(--soft-gray); opacity: 0.7; }
        input[type="text"]:focus, textarea:focus { outline: none; background: var(--input-focus-bg); border-bottom: 1px solid var(--primary-blue); }
        .scroll-box { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Priority Style Updated */
        .priority-row { margin-bottom: 6px; border-bottom: 1px dashed var(--border-color); height: 32px; display: flex; align-items: center; gap: 8px; }
        .priority-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--danger-red); flex-shrink: 0; }
        .priority-input { height: 100%; overflow-y: hidden; line-height: 20px; flex-grow: 1; }
        .priority-input:focus { overflow-y: auto; }

        /* Progress Bar */
        .progress-container { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        .progress-track { flex-grow: 1; height: 8px; background: var(--progress-bg); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-blue), var(--dark-blue)); width: 0%; transition: width 0.5s ease-out; }
        .progress-text { font-size: 12px; font-weight: bold; color: var(--primary-blue); width: 35px; text-align: right; }

        /* ToDo Styles with Drag */
        .todo-block { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px; margin-bottom: 8px; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .todo-block.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        
        .todo-header { display: flex; gap: 4px; margin-bottom: 4px; border-bottom: 1px dashed var(--border-color); padding-bottom: 4px; align-items: center;}
        
        /* Drag Handle */
        .drag-handle { cursor: grab; color: var(--soft-gray); font-size: 16px; padding: 0 4px; user-select: none; line-height: 1; }
        .drag-handle:active { cursor: grabbing; color: var(--primary-blue); }

        .date-input { width: 45%; text-align: center; font-size: 11px; font-weight: bold; color: var(--soft-gray); cursor: context-menu; background: var(--input-bg); border-radius: 4px; height: 22px; padding: 2px 0; border: 1px solid var(--border-color); }
        .date-input:focus { color: var(--text-color); background: var(--input-focus-bg);}
        .todo-body { display: flex; align-items: flex-start; }
        .todo-chk-wrap { width: 22px; display: flex; justify-content: center; padding-top: 5px; }
        .todo-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--primary-blue); margin: 0;}
        .todo-content { flex-grow: 1; margin-left: 4px; height: 36px; min-height: 24px; overflow-y: auto; line-height: 1.4; color: var(--text-color); }
        .todo-content.completed { text-decoration: line-through; color: var(--soft-gray); }
        .todo-content[readonly] { color: var(--soft-gray); cursor: default; }

        /* Priority Selector Styles */
        .priority-wrap { position: relative; width: 26px; height: 24px; display: flex; justify-content: center; align-items: center; margin-top: 2px; cursor: pointer; z-index: 10; }
        .priority-current { font-size: 13px; font-weight: bold; line-height: 1; user-select: none; transition: transform 0.1s; }
        .priority-current:hover { transform: scale(1.1); }
        .priority-menu { display: none; position: absolute; top: 100%; left: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; width: 80px; overflow: hidden; }
        .priority-option { padding: 8px 10px; font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-color); transition: background 0.1s; }
        .priority-option:hover { background: var(--input-focus-bg); }
        .prio-3 { color: #1e88e5; } .prio-2 { color: #43a047; } .prio-1 { color: #8e24aa; } .prio-0 { color: #bdbdbd; }

        /* Time Line */
        .timeline-block { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px; margin-bottom: 8px; }
        .timeline-header { display: flex; gap: 4px; margin-bottom: 4px; }
        .time-box { width: 50%; text-align: center; font-size: 11px; font-weight: bold; color: var(--soft-gray); cursor: context-menu; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; height: 22px; padding: 2px 0; }
        .time-box.filled { color: var(--text-color); border-color: var(--primary-blue); background-color: rgba(59, 130, 246, 0.1); }
        .timeline-text { height: 40px; overflow-y: auto; color: var(--text-color); }

        /* Rich Text Editor Styles */
        .editor-toolbar { display: flex; gap: 4px; padding: 4px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 5px; flex-wrap: wrap; background: var(--input-bg); border-radius: 4px; }
        .editor-btn { border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); cursor: pointer; border-radius: 3px; padding: 2px 6px; font-size: 11px; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .editor-btn:hover { background: var(--input-focus-bg); border-color: var(--primary-blue); }
        .editor-select { border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); border-radius: 3px; font-size: 11px; padding: 2px; height: 24px; }
        .note-area-rich { flex-grow: 1; overflow-y: auto; border: 1px solid transparent; font-size: 13px; padding: 4px; border-radius: 4px; outline: none; line-height: 1.5; min-height: 100px; color: var(--text-color); }
        .note-area-rich:focus { background: var(--input-focus-bg); border-bottom: 1px solid var(--primary-blue); }
        .note-area-rich b { font-weight: bold; }
        .note-area-rich i { font-style: italic; }
        .note-area-rich u { text-decoration: underline; }
        .note-area-rich s { text-decoration: line-through; }

        /* Right Column Layout */
        .calendar-card { flex: 1.5; min-height: 200px; padding: 10px; display: flex; flex-direction: column; }
        .note-card { flex: 1; min-height: 150px; display: flex; flex-direction: column; }
        .sp-card { flex: 0.8; }
        .sum-card { flex: 0.8; }
        .calendar-wrapper { flex-grow: 1; width: 100%; position: relative; overflow: hidden; border-radius: 8px; border: 1px solid var(--border-color); }
        iframe { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; border: 0; }

        /* Sp & Sum */
        .sp-grid { display: flex; gap: 8px; height: 100%; }
        .sp-item { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .sp-label { font-size: 11px; text-align: center; color: white; margin-bottom: 5px; font-weight: bold; flex: 0 0 auto; border-radius: 12px; padding: 3px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bg-green { background-color: #43a047; }
        .bg-orange { background-color: #fb8c00; }
        .bg-purple { background-color: #8e24aa; }
        .sp-text { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); font-size: 12px; overflow-y: auto; padding: 6px; }
        .sum-grid { display: flex; gap: 10px; height: 100%; }
        .sum-item { flex: 1; display: flex; flex-direction: column; border-radius: 6px; padding: 8px; height: 100%; border: 1px solid var(--border-color); }
        .sum-item.thanks { background: var(--input-bg); }
        .sum-item.summary { background: var(--input-bg); }
        .sum-label { font-size: 12px; font-weight: 800; text-align: center; color: var(--text-color); margin-bottom: 5px; flex: 0 0 auto; }
        .sum-text { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); overflow-y: auto; resize: none; font-size: 12px; padding: 6px; }

        /* Modal & Context Menu */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .chk-list label { display: block; margin: 10px 0; cursor: pointer; color: var(--text-color); }
        .modal-btns { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        #ctxMenu { display: none; position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 6px; z-index: 2000; min-width: 120px; }
        #ctxMenu div { padding: 8px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        #ctxMenu div:last-child { border-bottom: none; }
        #ctxMenu div:hover { background: var(--input-focus-bg); }
        
        #saveStatus { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 2001; }

        @media (max-width: 768px) {
            body { padding: 10px; height: auto; overflow-y: auto; }
            .container { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .card { min-height: auto; }
            .calendar-card { min-height: 400px !important; flex: auto; }
            .note-card { min-height: 300px; flex: auto; }
            .sp-card, .sum-card { min-height: auto; flex: auto; }
            .sp-grid, .sum-grid { flex-direction: column; height: auto; gap: 15px; }
            .sp-item, .sum-item { height: auto; min-height: 150px; }
            .sp-text, .sum-text { min-height: 120px; }
            header { flex-direction: column; align-items: flex-start; }
            .controls { width: 100%; justify-content: space-between; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="color:#1e3a8a; margin-bottom:10px;">My Cloud Dashboard V12</h2>
        <p style="color:#666; font-size:14px; margin-bottom:30px;">
            PCÏôÄ Ïä§ÎßàÌä∏Ìè∞ ÎèôÍ∏∞Ìôî ÏßÄÏõê<br>Î°úÍ∑∏Ïù∏ÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.
        </p>
        <button class="google-btn" onclick="googleLogin()">
            <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#fff" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#fff" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#fff" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
            Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏
        </button>
        <div style="margin-top:20px; font-size:11px; color:#999; text-align:left; background:#f9fafb; padding:10px; border-radius:8px;">
            <b>[ÏÑ§Ï†ï ÌôïÏù∏]</b><br>
            Ïä§ÌÅ¨Î¶ΩÌä∏ ÏòÅÏó≠Ïùò Firebase ConfigÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.
        </div>
    </div>
</div>

<header>
    <h1>Dashboard V12</h1>
    <div class="controls">
        <span class="date-display" id="headerDate">Loading...</span>
        <button class="btn btn-theme" onclick="toggleTheme()" title="Îã§ÌÅ¨ Î™®Îìú Ï†ÑÌôò">üåô</button>
        <div id="userInfo" class="user-info" style="display:none;">
            <img id="userImg" class="user-avatar" src="">
            <span id="userName">User</span>
        </div>
        <button class="btn btn-logout" onclick="logout()" style="display:none;" id="btnLogout">Î°úÍ∑∏ÏïÑÏõÉ</button>
        <button class="btn btn-export" onclick="exportData()">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        <button class="btn btn-reset" onclick="openResetModal()">ÏßÄÏö∞Í∏∞</button>
    </div>
</header>

<div class="container">
    <div class="column">
        <div class="card" style="flex: 0 0 auto;">
            <div class="section-title title-red">Top Priority 3</div>
            <div id="priorityBox">
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="1. Í∞ÄÏû• Ï§ëÏöîÌïú Ïùº"></textarea>
                </div>
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="2. Îëê Î≤àÏß∏ Ï§ëÏöîÌïú Ïùº"></textarea>
                </div>
                <div class="priority-row">
                    <input type="checkbox" class="priority-check">
                    <textarea class="priority-input" placeholder="3. ÏÑ∏ Î≤àÏß∏ Ï§ëÏöîÌïú Ïùº"></textarea>
                </div>
            </div>
        </div>
        <div class="card" style="flex: 1 1 auto;">
            <div class="section-title title-dark-blue" style="display:flex; justify-content:space-between; align-items:center;">
                To Do List
                <span style="font-size:11px; font-weight:normal; color:var(--soft-gray);">Drag to Reorder</span>
            </div>
            <!-- Progress Bar Added -->
            <div class="progress-container">
                <div class="progress-track">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            <div class="scroll-box" id="todoBox"></div>
        </div>
    </div>
    
    <div class="column">
        <div class="card" style="height: 100%;">
            <div class="section-title title-dark-blue">Time Line</div>
            <div class="scroll-box" id="timelineBox"></div>
        </div>
    </div>
    
    <div class="column">
        <div class="card calendar-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">
                <div class="section-title title-dark-blue" style="margin: 0; border: none; padding: 0;">Calendar</div>
                <a href="https://calendar.google.com" target="_blank" class="btn-sm">ÏùºÏ†ï Í¥ÄÎ¶¨ ‚Üó</a>
            </div>
            <div class="calendar-wrapper">
                <iframe id="calendarFrame" src="https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>

        <div class="card note-card">
            <div class="section-title title-dark-blue">Note</div>
            <div class="editor-toolbar">
                <select class="editor-select" onchange="formatDoc('fontSize', this.value); this.value='';">
                    <option value="" selected disabled>ÌÅ¨Í∏∞</option>
                    <option value="2">ÏûëÍ≤å</option>
                    <option value="3">Î≥¥ÌÜµ</option>
                    <option value="5">ÌÅ¨Í≤å</option>
                </select>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('bold')" title="ÍµµÍ≤å"><b>B</b></button>
                <button class="editor-btn" onclick="formatDoc('italic')" title="Í∏∞Ïö∏Í∏∞"><i>I</i></button>
                <button class="editor-btn" onclick="formatDoc('underline')" title="Î∞ëÏ§Ñ"><u>U</u></button>
                <button class="editor-btn" onclick="formatDoc('strikeThrough')" title="Í∞ÄÏö¥Îç∞Ï§Ñ"><s>S</s></button>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#333333')" title="Í≤ÄÏ†ïÏÉâ" style="color:black; font-weight:bold;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#d32f2f')" title="Îπ®Í∞ïÏÉâ" style="color:#d32f2f; font-weight:bold;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#3b82f6')" title="ÌååÎûëÏÉâ" style="color:#3b82f6; font-weight:bold;">A</button>
                <div style="width:1px; background:#ddd; margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('justifyLeft')" title="Ï¢åÏ∏°Ï†ïÎ†¨">Ï¢å</button>
                <button class="editor-btn" onclick="formatDoc('justifyCenter')" title="Í∞ÄÏö¥Îç∞Ï†ïÎ†¨">Ï§ë</button>
                <button class="editor-btn" onclick="formatDoc('justifyRight')" title="Ïö∞Ï∏°Ï†ïÎ†¨">Ïö∞</button>
            </div>
            <div class="note-area-rich" id="mainNote" contenteditable="true" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></div>
        </div>

        <div class="card sp-card">
            <div class="section-title title-dark-blue">Í≤ΩÍ±¥ÏÉùÌôú</div>
            <div class="sp-grid">
                <div class="sp-item"><span class="sp-label bg-green">Ïã§Ï≤ú</span><textarea class="sp-text" id="sp1"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-orange">Î∞òÏÑ±</span><textarea class="sp-text" id="sp2"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-purple">ÏÜåÎßù</span><textarea class="sp-text" id="sp3"></textarea></div>
            </div>
        </div>
        <div class="card sum-card">
            <div class="sum-grid">
                <div class="sum-item thanks"><span class="sum-label">THANKS GOD</span><textarea class="sum-text" id="thanksText"></textarea></div>
                <div class="sum-item summary"><span class="sum-label">SUMMARY</span><textarea class="sum-text" id="summaryText"></textarea></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="resetModal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--text-color);">Ìï≠Î™© ÏßÄÏö∞Í∏∞</h3>
        <div class="chk-list">
            <label><input type="checkbox" id="chkPri" checked> Top Priority</label>
            <label><input type="checkbox" id="chkTodo" checked> To Do List</label>
            <label><input type="checkbox" id="chkTime" checked> Time Line</label>
            <label><input type="checkbox" id="chkNote" checked> Note & Others</label>
        </div>
        <div class="modal-btns">
            <button class="btn" style="background:var(--soft-gray); color:#333" onclick="closeResetModal()">Ï∑®ÏÜå</button>
            <button class="btn btn-reset" onclick="executeReset()">ÏÇ≠Ï†ú</button>
        </div>
    </div>
</div>

<div id="ctxMenu">
    <div id="ctxItemInsert" onclick="handleCtx('insert')">ÏûÖÎ†•</div>
    <div id="ctxItemManual" onclick="handleCtx('manual')">ÏàòÎèôÏûÖÎ†•</div> 
    <div id="ctxItemClear" onclick="handleCtx('clear')">ÏßÄÏö∞Í∏∞</div>
</div>

<div id="saveStatus">Ï†ÄÏû•Îê®</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // [Ï§ëÏöî] Î≥∏Ïù∏Ïùò Firebase Config Í∞íÏúºÎ°ú ÍµêÏ≤¥ÌïòÏÑ∏Ïöî.
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY_HERE",
        authDomain: "your-app.firebaseapp.com",
        projectId: "your-app",
        storageBucket: "your-app.firebasestorage.app",
        messagingSenderId: "000000000000",
        appId: "1:000000000000:web:000000000000000000",
        measurementId: "G-XXXXXXXXXX"
    };

    let app, auth, db, currentUser;
    let unsubscribeSnapshot = null;
    let isRemoteUpdate = false; 

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase Init Error (Check Config):", e);
    }

    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch((error) => {
            alert("Î°úÍ∑∏Ïù∏ Ïã§Ìå®: " + error.message);
        });
    };

    window.logout = () => {
        if(confirm("Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            signOut(auth);
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('btnLogout').style.display = 'block';
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;

            const calFrame = document.getElementById('calendarFrame');
            if(user.email) {
                const encodedEmail = encodeURIComponent(user.email);
                calFrame.src = `https://calendar.google.com/calendar/embed?src=${encodedEmail}&ctz=Asia%2FSeoul`;
            }
            
            const docRef = doc(db, "dashboards", user.uid);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    isRemoteUpdate = true;
                    applyDataToUI(docSnap.data());
                    isRemoteUpdate = false;
                }
            });
        } else {
            currentUser = null;
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('btnLogout').style.display = 'none';
            const calFrame = document.getElementById('calendarFrame');
            calFrame.src = "https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul";
        }
    });

    let saveTimeout;
    window.triggerSave = () => {
        if(!currentUser || isRemoteUpdate) return;
        updateProgress(); // Ï†ÄÏû• Ï†Ñ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        const status = document.getElementById('saveStatus');
        status.innerText = "Ï†ÄÏû• Ï§ë...";
        status.style.opacity = 1;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { saveToCloud(); }, 1000);
    };

    async function saveToCloud() {
        if(!currentUser) return;
        const data = collectDataFromUI();
        try {
            await setDoc(doc(db, "dashboards", currentUser.uid), data, { merge: true });
            const status = document.getElementById('saveStatus');
            status.innerText = "ÎèôÍ∏∞Ìôî ÏôÑÎ£å";
            setTimeout(()=> { status.style.opacity = 0; }, 2000);
        } catch (e) {
            console.error("Save Error:", e);
            document.getElementById('saveStatus').innerText = "Ï†ÄÏû• Ïã§Ìå®";
        }
    }

    window.appSave = window.triggerSave; 
    window.forceSave = saveToCloud; 
</script>

<script>
    let ctxTarget = null;
    let ctxType = null;
    let draggedItem = null;

    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        loadTheme(); // ÌÖåÎßà Î°úÎìú
    });

    function initApp() {
        const headerDate = document.getElementById('headerDate');
        if (headerDate) {
            const now = new Date();
            headerDate.innerText = now.toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });
        }

        renderTodo(15);
        renderTimeline(15);

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÌÜµÌï©
        document.body.addEventListener('input', (e) => { 
            if(e.target.matches('.todo-check')) updateProgress();
            if(window.appSave) window.appSave(); 
        });
        document.body.addEventListener('change', (e) => { if(window.appSave) window.appSave(); });
        
        const mainNote = document.getElementById('mainNote');
        if (mainNote) {
            mainNote.addEventListener('input', (e) => { if(window.appSave) window.appSave(); });
        }
        
        document.addEventListener('click', (e) => {
            const ctxMenu = document.getElementById('ctxMenu');
            if (ctxMenu) ctxMenu.style.display = 'none';
            if (!e.target.closest('.priority-wrap')) {
                document.querySelectorAll('.priority-menu').forEach(m => m.style.display = 'none');
            }
        });
        
        setupDragAndDrop();
        updateProgress();
    };

    /* --- Theme Functions --- */
    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        if (isDark) {
            body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
        }
    }

    function loadTheme() {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }
    }

    /* --- Drag & Drop Functions --- */
    function setupDragAndDrop() {
        const todoBox = document.getElementById('todoBox');
        
        todoBox.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('todo-block')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                // ÎìúÎûòÍ∑∏ Ïãú ÏûîÏÉÅÏù¥ Î≥¥Ïù¥ÎèÑÎ°ù ÏïΩÍ∞Ñ ÏßÄÏó∞
                setTimeout(() => e.target.style.opacity = '0.5', 0);
            }
        });

        todoBox.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('todo-block')) {
                e.target.classList.remove('dragging');
                e.target.style.opacity = '';
                draggedItem = null;
                if(window.appSave) window.appSave();
            }
        });

        todoBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(todoBox, e.clientY);
            if (draggedItem) {
                if (afterElement == null) {
                    todoBox.appendChild(draggedItem);
                } else {
                    todoBox.insertBefore(draggedItem, afterElement);
                }
            }
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.todo-block:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    /* --- Progress Bar --- */
    function updateProgress() {
        const todos = document.querySelectorAll('.todo-block');
        let total = 0;
        let checked = 0;
        
        todos.forEach(el => {
            const val = el.querySelector('.todo-content').value.trim();
            const isChecked = el.querySelector('.todo-check').checked;
            
            // ÎÇ¥Ïö©Ïù¥ ÏûàÎäî Ìï≠Î™©Îßå Ïπ¥Ïö¥Ìä∏ (Îπà Ìï≠Î™© Ï†úÏô∏)
            if(val !== "") {
                total++;
                if(isChecked) checked++;
            }
        });

        const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = percent + '%';
    }

    /* --- Data Handling --- */

    function collectDataFromUI() {
        const priRows = Array.from(document.querySelectorAll('#priorityBox .priority-row'));
        const priData = priRows.map(r => ({
            t: r.querySelector('textarea').value,
            c: r.querySelector('input[type="checkbox"]').checked
        }));

        // DOM ÏàúÏÑúÎåÄÎ°ú ÏàòÏßëÌïòÎØÄÎ°ú ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í≤∞Í≥ºÍ∞Ä Î∞òÏòÅÎê®
        return {
            pri: priData, 
            todo: Array.from(document.querySelectorAll('.todo-block')).map(r => ({
                s: r.querySelector('.t-start').value,
                e: r.querySelector('.t-end').value,
                c: r.querySelector('.todo-check').checked,
                p: r.querySelector('.priority-current').getAttribute('data-val') || '0',
                t: r.querySelector('.todo-content').value
            })),
            line: Array.from(document.querySelectorAll('.timeline-block')).map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            })),
            note: document.getElementById('mainNote').innerHTML,
            sp: [document.getElementById('sp1').value, document.getElementById('sp2').value, document.getElementById('sp3').value],
            sum: [document.getElementById('thanksText').value, document.getElementById('summaryText').value]
        };
    }

    function applyDataToUI(d) {
        if(!d) return;

        const safeVal = (el, val) => {
            if(el && el !== document.activeElement && el.value !== val) {
                el.value = val;
            }
        };

        const priRows = document.querySelectorAll('#priorityBox .priority-row');
        if(d.pri && Array.isArray(d.pri)) {
            d.pri.forEach((v, i) => {
                if(priRows[i]) {
                    const txt = typeof v === 'object' ? v.t : v;
                    const chk = typeof v === 'object' ? v.c : false;
                    safeVal(priRows[i].querySelector('textarea'), txt);
                    priRows[i].querySelector('input[type="checkbox"]').checked = chk;
                }
            });
        }

        // ToDo: DB Îç∞Ïù¥ÌÑ∞ Í∞úÏàòÎßåÌÅº UI Î†åÎçîÎßÅ Ï°∞Ï†ï (Í∏∞Ï°¥Î≥¥Îã§ ÎßéÏúºÎ©¥ Ï∂îÍ∞Ä, Ï†ÅÏúºÎ©¥ Í∞íÎßå Ï±ÑÏõÄ)
        // Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®Ìûà Í∞íÎßå Îß§ÌïëÌïòÍ≥†, ÌïÑÏöîÏãú DOM Ïû¨ÏÉùÏÑ± Î°úÏßÅ Ï∂îÍ∞Ä Í∞ÄÎä•ÌïòÎÇò
        // ÌòÑÏû¨Îäî Í≥†Ï†ï 15Í∞ú Ïä¨Î°ØÏóê Îß§ÌïëÌï®.
        const tBlocks = document.querySelectorAll('.todo-block');
        // ÎßåÏïΩ Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä Îçî ÎßéÏúºÎ©¥ Î∏îÎ°ùÏùÑ Ï∂îÍ∞ÄÌï¥Ïïº Ìï®? -> ÌòÑÏû¨ Íµ¨Ï°∞ÏÉÅ 15Í∞ú Í≥†Ï†ï Í∂åÏû•
        
        if(d.todo) d.todo.forEach((v,i) => {
            if(tBlocks[i]) {
                safeVal(tBlocks[i].querySelector('.t-start'), v.s);
                safeVal(tBlocks[i].querySelector('.t-end'), v.e);
                
                const chk = tBlocks[i].querySelector('.todo-check');
                if(chk.checked !== v.c) {
                    chk.checked = v.c;
                    const content = tBlocks[i].querySelector('.todo-content');
                    if(v.c) {
                        content.classList.add('completed');
                        content.readOnly = true;
                    } else {
                        content.classList.remove('completed');
                        content.readOnly = false;
                    }
                }
                
                const prioEl = tBlocks[i].querySelector('.priority-current');
                if(prioEl) {
                    const savedP = v.p || '0';
                    if (prioEl.getAttribute('data-val') !== savedP) {
                        updatePriorityUI(prioEl, savedP);
                    }
                }

                safeVal(tBlocks[i].querySelector('.todo-content'), v.t);
            }
        });

        const lBlocks = document.querySelectorAll('.timeline-block');
        if(d.line) d.line.forEach((v,i) => {
            if(lBlocks[i]) {
                const s = lBlocks[i].querySelector('.tm-start');
                const e = lBlocks[i].querySelector('.tm-end');
                safeVal(s, v.s);
                safeVal(e, v.e);
                if(v.s) s.classList.add('filled'); else s.classList.remove('filled');
                if(v.e) e.classList.add('filled'); else e.classList.remove('filled');
                safeVal(lBlocks[i].querySelector('.timeline-text'), v.t);
            }
        });

        const noteDiv = document.getElementById('mainNote');
        if(d.note && noteDiv.innerHTML !== d.note && document.activeElement !== noteDiv) {
            noteDiv.innerHTML = d.note;
        }
        
        safeVal(document.getElementById('sp1'), d.sp[0]||''); 
        safeVal(document.getElementById('sp2'), d.sp[1]||'');
        safeVal(document.getElementById('sp3'), d.sp[2]||'');
        safeVal(document.getElementById('thanksText'), d.sum[0]||'');
        safeVal(document.getElementById('summaryText'), d.sum[1]||'');

        updateProgress(); // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ ÏßÑÌñâÎ•† Í∞±Ïã†
    }

    function formatDoc(cmd, value=null) {
        if(value) document.execCommand(cmd, false, value);
        else document.execCommand(cmd);
        document.getElementById('mainNote').focus();
        if(window.appSave) window.appSave();
    }

    function renderTodo(count) {
        const box = document.getElementById('todoBox');
        let html = '';
        for(let i=0; i<count; i++) {
            html += `
            <div class="todo-block" draggable="true">
                <div class="todo-header">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="text" class="date-input t-start" placeholder="ÏãúÏûë" readonly 
                           onclick="handleDateClick(this)"
                           onkeydown="handleInputKey(event, this, 'date-kr')"
                           oncontextmenu="openCtx(event, this, 'reset-only')">
                    <input type="text" class="date-input t-end" placeholder="ÎßàÏπ®" readonly>
                </div>
                <div class="todo-body">
                    <div class="todo-chk-wrap">
                        <input type="checkbox" class="todo-check" onchange="toggleTodo(this)">
                    </div>
                    <div class="priority-wrap" onclick="togglePrio(this)">
                        <div class="priority-current prio-0" data-val="0">Í∏∞</div>
                        <div class="priority-menu">
                            <div class="priority-option prio-3" onclick="setPrio(event, this, '3')">ÏóÖÎ¨¥</div>
                            <div class="priority-option prio-2" onclick="setPrio(event, this, '2')">Í∞úÏù∏</div>
                            <div class="priority-option prio-1" onclick="setPrio(event, this, '1')">ÍµêÌöå</div>
                            <div class="priority-option prio-0" onclick="setPrio(event, this, '0')">Í∏∞ÌÉÄ</div>
                        </div>
                    </div>
                    <textarea class="todo-content" placeholder="Ìï† Ïùº ÏûÖÎ†•" oninput="updateProgress()"></textarea>
                </div>
            </div>`;
        }
        box.innerHTML = html;
    }

    function togglePrio(wrapper) {
        const menu = wrapper.querySelector('.priority-menu');
        document.querySelectorAll('.priority-menu').forEach(m => {
            if(m !== menu) m.style.display = 'none';
        });
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    function setPrio(e, el, val) {
        e.stopPropagation(); 
        const wrapper = el.closest('.priority-wrap');
        const current = wrapper.querySelector('.priority-current');
        updatePriorityUI(current, val);
        wrapper.querySelector('.priority-menu').style.display = 'none';
        if(window.appSave) window.appSave();
    }

    function updatePriorityUI(el, val) {
        el.setAttribute('data-val', val);
        el.className = 'priority-current'; 
        el.classList.add('prio-' + val);
        switch(val) {
            case '3': el.innerText = 'ÏóÖ'; break;
            case '2': el.innerText = 'Í∞ú'; break;
            case '1': el.innerText = 'Íµê'; break;
            default:  el.innerText = 'Í∏∞'; break;
        }
    }

    function renderTimeline(count) {
        const box = document.getElementById('timelineBox');
        let html = '';
        for(let i=0; i<count; i++) {
            html += `
            <div class="timeline-block">
                <div class="timeline-header">
                    <input type="text" class="time-box tm-start" placeholder="ÏãúÏûë" 
                           onclick="handleTimeClick(this)" 
                           onblur="handleTimeBlur(this)"
                           onkeydown="handleInputKey(event, this, 'time-kr')" 
                           oncontextmenu="openCtx(event, this, 'time-menu')">
                    <input type="text" class="time-box tm-end" placeholder="ÎßàÏπ®" 
                           onclick="handleTimeClick(this)" 
                           onblur="handleTimeBlur(this)"
                           onkeydown="handleInputKey(event, this, 'time-kr')" 
                           oncontextmenu="openCtx(event, this, 'time-menu')">
                </div>
                <textarea class="timeline-text" placeholder="ÎÇ¥Ïö©"></textarea>
            </div>`;
        }
        box.innerHTML = html;
    }

    function getFormattedDateTime() {
        const now = new Date();
        const yy = now.getFullYear().toString().slice(-2);
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const dd = now.getDate().toString().padStart(2, '0');
        const hh = now.getHours().toString().padStart(2, '0');
        const mi = now.getMinutes().toString().padStart(2, '0');
        return `${yy}ÎÖÑ${mm}Ïõî${dd}Ïùº${hh}Ïãú${mi}Î∂Ñ`;
    }

    function handleDateClick(el) {
        if(!el.value) { // Í∞íÏù¥ ÏóÜÏùÑ ÎïåÎßå ÏûêÎèô ÏûÖÎ†• (ÏàòÏ†ï Ìé∏ÏùòÏÑ±)
            el.value = getFormattedDateTime();
            if(window.appSave) window.appSave();
        }
    }

    function handleTimeClick(el) {
        // ÌÉÄÏûÑÎùºÏù∏ÏùÄ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏûÖÎ†•Ìï† Ïàò ÏûàÎèÑÎ°ù onclick ÏûêÎèôÏûÖÎ†•ÏùÄ Ï†úÍ±∞ÌïòÍ±∞ÎÇò Ï°∞Í±¥Î∂Ä Ï≤òÎ¶¨
        // Ïó¨Í∏∞ÏÑúÎäî Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄÌïòÎêò, Í∞íÏù¥ ÏóÜÏùÑ ÎïåÎßå ÌòÑÏû¨ÏãúÍ∞Ñ ÏûÖÎ†•
        if(!el.value && !el.readOnly) {
            el.value = getFormattedDateTime();
            el.classList.add('filled');
            if(window.appSave) window.appSave();
        }
    }

    /* Smart Time Format (e.g. 1430 -> 14:30) */
    function handleTimeBlur(el) {
        let val = el.value.replace(/[^0-9]/g, '');
        if (val.length === 4) {
            const h = val.substring(0,2);
            const m = val.substring(2,4);
            if (parseInt(h) < 24 && parseInt(m) < 60) {
                el.value = `${h}:${m}`;
                el.classList.add('filled');
                if(window.appSave) window.appSave();
            }
        }
    }

    function handleInputKey(e, el, type) {
        if(e.key === 'Enter') {
            e.preventDefault();
            // ÏãúÍ∞Ñ ÏûÖÎ†•ÏóêÏÑú ÏóîÌÑ∞ÌÇ§ ÎàÑÎ•¥Î©¥ Ìè¨Îß∑ÌåÖ ÏãúÎèÑ
            if(type === 'time-kr') {
                handleTimeBlur(el);
                el.blur(); // Ìè¨Ïª§Ïä§ ÏïÑÏõÉ
            } else {
                el.value = getFormattedDateTime();
                if(window.appSave) window.appSave();
            }
        }
    }

    function toggleTodo(chk) {
        const block = chk.closest('.todo-block');
        const end = block.querySelector('.t-end');
        const txt = block.querySelector('.todo-content');
        if(chk.checked) {
            end.value = getFormattedDateTime(); 
            txt.classList.add('completed');
            txt.readOnly = true; 
        } else {
            end.value = '';
            txt.classList.remove('completed');
            txt.readOnly = false; 
        }
        updateProgress();
        if(window.appSave) window.appSave();
    }

    function openCtx(e, el, type) {
        e.preventDefault();
        ctxTarget = el;
        ctxType = type;
        const menu = document.getElementById('ctxMenu');
        const itemInsert = document.getElementById('ctxItemInsert');
        const itemManual = document.getElementById('ctxItemManual');
        const itemClear = document.getElementById('ctxItemClear');

        itemInsert.style.display = 'none';
        itemManual.style.display = 'none';
        itemClear.innerText = 'ÏßÄÏö∞Í∏∞';

        if (type === 'reset-only') {
            itemClear.innerText = 'Ï¥àÍ∏∞Ìôî';
        } else if (type === 'time-menu') {
            itemManual.style.display = 'block'; 
            itemClear.innerText = 'Ï¥àÍ∏∞Ìôî';
        } else {
            itemInsert.style.display = 'block';
            itemInsert.innerText = "Ïò§Îäò ÎÇ†Ïßú ÏûÖÎ†•";
        }

        menu.style.display = 'block';
        
        let x = e.pageX;
        let y = e.pageY;
        if(x + 120 > window.innerWidth) x -= 120;
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }

    function handleCtx(action) {
        if(!ctxTarget) return;
        
        if (action === 'manual') {
            const input = prompt("ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 1430)");
            if (input) {
                ctxTarget.value = input; // ÏûÖÎ†• ÌõÑ blur Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞ Ïú†ÎèÑ
                handleTimeBlur(ctxTarget);
            }
        } else if (action === 'insert') {
            ctxTarget.value = getFormattedDateTime();
        } else {
            ctxTarget.value = '';
            ctxTarget.classList.remove('filled');
        }
        
        if(window.appSave) window.appSave();
        document.getElementById('ctxMenu').style.display = 'none'; 
    }

    function openResetModal() { document.getElementById('resetModal').style.display='flex'; }
    function closeResetModal() { document.getElementById('resetModal').style.display='none'; }
    
    function executeReset() {
        if(document.getElementById('chkPri').checked) {
            document.querySelectorAll('#priorityBox .priority-row').forEach(row => {
                row.querySelector('textarea').value = '';
                row.querySelector('input[type="checkbox"]').checked = false;
            });
        }
        if(document.getElementById('chkTime').checked) {
            document.querySelectorAll('.timeline-block input').forEach(e=> { e.value=''; e.classList.remove('filled'); });
            document.querySelectorAll('.timeline-block textarea').forEach(e=>e.value='');
        }
        if(document.getElementById('chkNote').checked) {
            document.getElementById('mainNote').innerHTML = '';
            ['sp1','sp2','sp3','thanksText','summaryText'].forEach(id=>document.getElementById(id).value='');
        }
        if(document.getElementById('chkTodo').checked) {
            const blocks = document.querySelectorAll('.todo-block');
            blocks.forEach(r => {
                r.querySelector('.t-start').value=''; r.querySelector('.t-end').value='';
                r.querySelector('.todo-check').checked=false; r.querySelector('.todo-content').value='';
                r.querySelector('.todo-content').classList.remove('completed');
                r.querySelector('.todo-content').readOnly = false;
                const p = r.querySelector('.priority-current');
                if(p) updatePriorityUI(p, '0');
            });
            updateProgress(); // Ï¥àÍ∏∞Ìôî ÌõÑ ÏßÑÌñâÎ•† Î∞òÏòÅ
        }
        if(window.appSave) window.appSave();
        closeResetModal();
    }

    function exportData() {
        // [Ï§ëÏöî] ÏÉàÎ°ú Î∞∞Ìè¨Ìïú Íµ¨Í∏Ä Ïï±Ïä§ Ïä§ÌÅ¨Î¶ΩÌä∏ URLÏùÑ Ïó¨Í∏∞Ïóê ÎÑ£ÏúºÏÑ∏Ïöî
        const scriptURL = "Ïó¨Í∏∞Ïóê_Íµ¨Í∏Ä_ÏõπÏï±_URL_Î∂ôÏó¨ÎÑ£Í∏∞"; 

        if(!scriptURL || scriptURL.includes("Ïó¨Í∏∞Ïóê")) {
            alert("ÏΩîÎìúÎ•º ÏàòÏ†ïÌïòÏó¨ 'scriptURL' Î≥ÄÏàòÏóê Íµ¨Í∏Ä Ïï±Ïä§ Ïä§ÌÅ¨Î¶ΩÌä∏ Î∞∞Ìè¨ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
            return;
        }

        if(!confirm("Ï≤¥ÌÅ¨Îêú Ìï≠Î™©Îßå ÎÇ¥Î≥¥ÎÇ¥Í≥† ÌôîÎ©¥ÏùÑ Ï†ïÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

        const btn = document.querySelector('.btn-export');
        const originalText = btn.innerText;
        btn.innerText = "Ï†ÑÏÜ° Ï§ë...";

        const getPrioShape = (val) => {
            if(val === '3') return '‚òÖ';
            if(val === '2') return '‚ñ†';
            if(val === '1') return '‚óè';
            return '‚óã';
        };

        const priRows = Array.from(document.querySelectorAll('#priorityBox .priority-row'));
        const exportPri = priRows
            .filter(r => r.querySelector('input[type="checkbox"]').checked)
            .map(r => r.querySelector('textarea').value);
        
        const keptPriTexts = priRows
            .filter(r => !r.querySelector('input[type="checkbox"]').checked && r.querySelector('textarea').value.trim() !== "")
            .map(r => r.querySelector('textarea').value);

        const allBlockEls = Array.from(document.querySelectorAll('.todo-block'));
        const allTodosRaw = allBlockEls.map(r => ({
            s: r.querySelector('.t-start').value,
            e: r.querySelector('.t-end').value,
            c: r.querySelector('.todo-check').checked,
            p_val: r.querySelector('.priority-current').getAttribute('data-val') || '0', 
            t: r.querySelector('.todo-content').value
        }));

        const exportTodos = allTodosRaw
            .filter(t => t.c === true)
            .map(t => ({
                s: t.s,
                e: t.e,
                c: t.c,
                p: getPrioShape(t.p_val), 
                t: t.t
            }));
        
        const keptTodos = allTodosRaw.filter(t => t.c === false && t.t.trim() !== "");

        const timelineData = Array.from(document.querySelectorAll('.timeline-block'))
            .map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            }))
            .filter(l => l.t.trim() !== ""); 

        const payload = {
            pri: exportPri,
            todo: exportTodos, 
            line: timelineData, 
            note: document.getElementById('mainNote').innerText,
            sp: [
                document.getElementById('sp1').value, 
                document.getElementById('sp2').value, 
                document.getElementById('sp3').value
            ],
            sum: [
                document.getElementById('thanksText').value, 
                document.getElementById('summaryText').value
            ]
        };

        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success') {
                alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\nÍ∞Å Ìï≠Î™©Ïù¥ Í∞úÎ≥Ñ ÌñâÏúºÎ°ú ÏûÖÎ†•Îê©ÎãàÎã§.");
                resetAndRestore(keptTodos, keptPriTexts);
            } else {
                alert("Ï†ÑÏÜ° Ïã§Ìå®: " + data.error);
            }
        })
        .catch(error => {
            console.error('Export Error:', error);
            alert("Ï†ÑÏÜ° ÏöîÏ≤≠ ÏôÑÎ£å! (Îç∞Ïù¥ÌÑ∞Í∞Ä ÏãúÌä∏Ïóê Îì§Ïñ¥Í∞îÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî)\nÌôîÎ©¥ÏùÑ Ï†ïÎ¶¨Ìï©ÎãàÎã§.");
            resetAndRestore(keptTodos, keptPriTexts);
        })
        .finally(() => {
            btn.innerText = originalText;
        });
    }

    function resetAndRestore(keptTodos, keptPriTexts) {
        // A. Ï¥àÍ∏∞Ìôî
        const priRows = document.querySelectorAll('#priorityBox .priority-row');
        priRows.forEach(r => {
            r.querySelector('textarea').value = '';
            r.querySelector('input[type="checkbox"]').checked = false;
        });

        document.querySelectorAll('.timeline-block input').forEach(e => { e.value = ''; e.classList.remove('filled'); });
        document.querySelectorAll('.timeline-block textarea').forEach(e => e.value = '');
        document.getElementById('mainNote').innerHTML = '';
        ['sp1', 'sp2', 'sp3', 'thanksText', 'summaryText'].forEach(id => document.getElementById(id).value = '');

        const blocks = document.querySelectorAll('.todo-block');
        blocks.forEach(r => {
            r.querySelector('.t-start').value = '';
            r.querySelector('.t-end').value = '';
            r.querySelector('.todo-check').checked = false;
            r.querySelector('.todo-content').value = '';
            r.querySelector('.todo-content').classList.remove('completed');
            r.querySelector('.todo-content').readOnly = false; 
            const p = r.querySelector('.priority-current');
            if(p) updatePriorityUI(p, '0'); 
        });

        // B. Restore
        if (keptPriTexts && keptPriTexts.length > 0) {
            keptPriTexts.forEach((txt, idx) => {
                if (priRows[idx]) {
                    priRows[idx].querySelector('textarea').value = txt;
                }
            });
        }

        keptTodos.forEach((item, index) => {
            if(blocks[index]) {
                blocks[index].querySelector('.t-start').value = item.s;
                blocks[index].querySelector('.t-end').value = item.e; 
                blocks[index].querySelector('.todo-content').value = item.t;
                
                const p = blocks[index].querySelector('.priority-current');
                if(p) updatePriorityUI(p, item.p_val);
            }
        });

        updateProgress();
        if(window.forceSave) window.forceSave(); 
    }
</script>
</body>
</html>
