<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart Dashboard V14 (Login Restored)</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #3b82f6; --primary-hover: #2563eb;
            --dark-blue: #1e3a8a; --danger-red: #d32f2f;
            --soft-gray: #9ca3af; --dark-gray: #333333; 
            --bg-color: #f3f4f6; --card-bg: #ffffff; 
            --text-main: #333333; --text-sub: #666666;
            --border-color: #e5e7eb;
            --border-radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg-color: #111827; --card-bg: #1f2937;
            --text-main: #f3f4f6; --text-sub: #9ca3af;
            --border-color: #374151;
            --dark-blue: #60a5fa; 
            --danger-red: #f87171;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 15px; height: 100vh; overflow-y: auto; transition: background 0.3s, color 0.3s; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 15px; flex-wrap: wrap; gap: 10px; transition: background 0.3s; }
        h1 { margin: 0; font-size: 24px; color: var(--primary-blue); font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .date-display { font-weight: 700; color: var(--text-main); margin-right: 10px; font-size: 15px; }
        
        .btn { border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-export { background-color: var(--primary-blue); }
        .btn-reset { background-color: var(--danger-red); }
        .btn-login { background-color: #4285F4; }
        .btn-logout { background-color: #4b5563; }
        .btn-theme { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); padding: 8px; font-size: 16px; }

        .user-info { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; color: var(--dark-blue); }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }

        /* Container & Cards */
        .container { display: grid; grid-template-columns: 28% 22% 48%; gap: 15px; min-height: 850px; height: calc(100vh - 100px); }
        .column { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; position: relative; }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .title-dark-blue { color: var(--dark-blue) !important; }
        .title-red { color: var(--danger-red) !important; }

        /* Inputs */
        input[type="text"], textarea { width: 100%; border: 1px solid transparent; background: transparent; font-family: inherit; color: var(--text-main); font-size: 13px; padding: 4px; border-radius: 4px; resize: none; }
        ::placeholder { color: var(--text-sub); opacity: 0.6; }
        input[type="text"]:focus, textarea:focus { outline: none; background: rgba(59, 130, 246, 0.1); border-bottom: 1px solid var(--primary-blue); }
        
        .scroll-box { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Priority */
        .priority-row { margin-bottom: 6px; border-bottom: 1px dashed var(--border-color); height: 32px; display: flex; align-items: center; gap: 8px; }
        .priority-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--danger-red); flex-shrink: 0; }
        .priority-input { height: 100%; overflow-y: hidden; line-height: 20px; flex-grow: 1; }
        .priority-input:focus { overflow-y: auto; }

        /* ToDo Items */
        .todo-block { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px; margin-bottom: 8px; transition: background 0.3s; }
        .todo-header { display: flex; gap: 4px; margin-bottom: 4px; border-bottom: 1px dashed var(--border-color); padding-bottom: 4px;}
        .date-input { width: 50%; text-align: center; font-size: 11px; font-weight: bold; color: var(--text-sub); cursor: context-menu; background: rgba(0,0,0,0.02); border-radius: 4px; height: 22px; padding: 2px 0; }
        .date-input:focus { color: var(--text-main); background: rgba(59, 130, 246, 0.1);}
        
        .todo-body { display: flex; align-items: flex-start; }
        .todo-chk-wrap { width: 22px; display: flex; justify-content: center; padding-top: 5px; }
        .todo-check { width: 14px; height: 14px; cursor: pointer; accent-color: var(--primary-blue); margin: 0;}
        .todo-content { flex-grow: 1; margin-left: 4px; height: 36px; min-height: 24px; overflow-y: auto; line-height: 1.4; }
        .todo-content.completed { text-decoration: line-through; color: var(--text-sub); opacity: 0.7; }
        
        /* Priority Selector */
        .priority-wrap { position: relative; width: 26px; height: 24px; display: flex; justify-content: center; align-items: center; margin-top: 2px; cursor: pointer; z-index: 10; }
        .priority-current { font-size: 13px; font-weight: bold; line-height: 1; user-select: none; transition: transform 0.1s; }
        .priority-current:hover { transform: scale(1.1); }
        .priority-menu { display: none; position: absolute; top: 100%; left: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; width: 80px; overflow: hidden; }
        .priority-option { padding: 8px 10px; font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-main); }
        .priority-option:hover { background: var(--bg-color); }
        .prio-3 { color: #3b82f6; } .prio-2 { color: #10b981; } .prio-1 { color: #8b5cf6; } .prio-0 { color: #9ca3af; }

        /* Timeline */
        .timeline-block { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px; margin-bottom: 8px; }
        .time-box { width: 50%; text-align: center; font-size: 11px; font-weight: bold; color: var(--text-sub); cursor: context-menu; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; height: 22px; padding: 2px 0; }
        .time-box.filled { color: var(--text-main); border-color: var(--primary-blue); background-color: rgba(59, 130, 246, 0.05); }

        /* Add More Button */
        .btn-add-more { width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--border-color); color: var(--text-sub); border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 5px; transition: 0.2s; }
        .btn-add-more:hover { border-color: var(--primary-blue); color: var(--primary-blue); background: rgba(59, 130, 246, 0.05); }

        /* Rich Text Editor */
        .editor-toolbar { display: flex; gap: 4px; padding: 4px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 5px; flex-wrap: wrap; background: var(--bg-color); border-radius: 4px; }
        .editor-btn { border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; border-radius: 3px; padding: 2px 6px; font-size: 11px; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--text-main); }
        .editor-btn:hover { background: rgba(59, 130, 246, 0.1); border-color: var(--primary-blue); }
        .editor-select { border: 1px solid var(--border-color); border-radius: 3px; font-size: 11px; padding: 2px; height: 24px; background: var(--card-bg); color: var(--text-main); }
        .note-area-rich { flex-grow: 1; overflow-y: auto; border: 1px solid transparent; font-size: 13px; padding: 4px; border-radius: 4px; outline: none; line-height: 1.5; min-height: 100px; color: var(--text-main); }
        .note-area-rich:focus { background: rgba(59, 130, 246, 0.05); border-bottom: 1px solid var(--primary-blue); }

        /* Sp & Sum */
        .sp-grid { display: flex; gap: 8px; height: 100%; }
        .sp-item { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .sp-label { font-size: 11px; text-align: center; color: white; margin-bottom: 5px; font-weight: bold; flex: 0 0 auto; border-radius: 12px; padding: 3px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bg-green { background-color: #10b981; } .bg-orange { background-color: #f59e0b; } .bg-purple { background-color: #8b5cf6; }
        .sp-text { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); font-size: 12px; overflow-y: auto; padding: 6px; }
        
        .sum-grid { display: flex; gap: 10px; height: 100%; }
        .sum-item { flex: 1; display: flex; flex-direction: column; border-radius: 6px; padding: 8px; height: 100%; border: 1px solid var(--border-color); }
        .sum-item.thanks { background: rgba(255, 251, 235, 0.5); }
        .sum-item.summary { background: rgba(239, 246, 255, 0.5); }
        [data-theme="dark"] .sum-item.thanks { background: rgba(251, 191, 36, 0.1); }
        [data-theme="dark"] .sum-item.summary { background: rgba(59, 130, 246, 0.1); }
        .sum-label { font-size: 12px; font-weight: 800; text-align: center; color: var(--text-sub); margin-bottom: 5px; flex: 0 0 auto; }
        .sum-text { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); overflow-y: auto; resize: none; font-size: 12px; padding: 6px; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; height: auto; overflow-y: auto; }
            .container { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .card { min-height: auto; }
            .calendar-card { min-height: 500px !important; flex: auto; }
            .note-card { min-height: 300px; flex: auto; }
            .sp-card, .sum-card { min-height: auto; flex: auto; }
            .sp-grid, .sum-grid { flex-direction: column; height: auto; gap: 15px; }
            .sp-item, .sum-item { height: auto; min-height: 150px; }
            header { flex-direction: column; align-items: flex-start; }
            .controls { width: 100%; justify-content: space-between; margin-top: 10px; }
        }

        /* Modal & Context Menu */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-color); z-index: 9999; 
            display: flex; /* [복구됨] 로그인 화면 표시 */
            flex-direction: column; justify-content: center; align-items: center; text-align: center; 
        }
        .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
        
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 300px; border: 1px solid var(--border-color); }
        .chk-list label { display: block; margin: 10px 0; cursor: pointer; color: var(--text-main); }
        
        #ctxMenu { display: none; position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 6px; z-index: 2000; min-width: 120px; }
        #ctxMenu div { padding: 8px 15px; font-size: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        #ctxMenu div:last-child { border-bottom: none; }
        #ctxMenu div:hover { background: var(--bg-color); }
        
        #saveStatus { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="color:var(--dark-blue); margin-bottom:10px;">My DeskV.02</h2>
        <p style="color:var(--text-sub); font-size:14px; margin-bottom:30px;">
            PC와 스마트폰에서 데이터를<br>동기화하기 위해 로그인하세요.
        </p>
        <button class="btn btn-login" style="width:100%; justify-content:center; padding:12px;" onclick="googleLogin()">
            <i class="fab fa-google"></i> 구글 계정으로 로그인
        </button>
        <div style="margin-top:20px; font-size:11px; color:var(--text-sub); text-align:left; background:var(--bg-color); padding:10px; border-radius:8px;">
            <b>[필수 설정]</b><br>
            스크립트 영역의 Firebase Config가 올바른지 확인하세요.
        </div>
    </div>
</div>

<header>
    <h1><i class="fas fa-chart-line"></i> My Dashboard</h1>
    <div class="controls">
        <span class="date-display" id="headerDate">Loading...</span>
        <button class="btn btn-theme" onclick="toggleTheme()" title="테마 변경"><i class="fas fa-moon"></i></button>
        <div id="userInfo" class="user-info" style="display:none;">
            <img id="userImg" class="user-avatar" src="">
            <span id="userName">User</span>
        </div>
        <button class="btn btn-logout" onclick="logout()" style="display:none;" id="btnLogout"><i class="fas fa-sign-out-alt"></i></button>
        <button class="btn btn-export" onclick="exportData()"><i class="fas fa-file-export"></i> Export</button>
        <button class="btn btn-reset" onclick="openResetModal()"><i class="fas fa-trash-alt"></i> Reset</button>
    </div>
</header>

<div class="container">
    <div class="column">
        <div class="card" style="flex: 0 0 auto;">
            <div class="section-title title-red">Top Priority 3</div>
            <div id="priorityBox">
                <div class="priority-row"><input type="checkbox" class="priority-check"><textarea class="priority-input" placeholder="1. 가장 중요한 일"></textarea></div>
                <div class="priority-row"><input type="checkbox" class="priority-check"><textarea class="priority-input" placeholder="2. 그 다음 중요한 일"></textarea></div>
                <div class="priority-row"><input type="checkbox" class="priority-check"><textarea class="priority-input" placeholder="3. 잊지 말아야 할 일"></textarea></div>
            </div>
        </div>
        <div class="card" style="flex: 1 1 auto;">
            <div class="section-title title-dark-blue">
                To Do List <span style="font-size:11px; color:var(--text-sub); font-weight:normal;" id="todoCount">(0)</span>
            </div>
            <div class="scroll-box" id="todoBox"></div>
            <button class="btn-add-more" onclick="addTodoRow()"><i class="fas fa-plus"></i> 항목 추가</button>
        </div>
    </div>
    
    <div class="column">
        <div class="card" style="height: 100%;">
            <div class="section-title title-dark-blue">Time Line</div>
            <div class="scroll-box" id="timelineBox"></div>
            <button class="btn-add-more" onclick="addTimelineRow()"><i class="fas fa-plus"></i> 항목 추가</button>
        </div>
    </div>
    
    <div class="column">
        <div class="card calendar-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">
                <div class="section-title title-dark-blue" style="margin: 0; border: none; padding: 0;">Calendar</div>
                <a href="https://calendar.google.com" target="_blank" class="btn" style="background:var(--bg-color); color:var(--primary-blue); padding:4px 8px; font-size:11px;">일정 관리 <i class="fas fa-external-link-alt"></i></a>
            </div>
            <div style="flex-grow: 1; width: 100%; position: relative; overflow: hidden; border-radius: 8px; border: 1px solid var(--border-color);">
                <iframe id="calendarFrame" src="https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul" style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"></iframe>
            </div>
        </div>

        <div class="card note-card">
            <div class="section-title title-dark-blue">Note</div>
            <div class="editor-toolbar">
                <select class="editor-select" onchange="formatDoc('fontSize', this.value); this.value='';">
                    <option value="" selected disabled>크기</option>
                    <option value="2">작게</option>
                    <option value="3">보통</option>
                    <option value="5">크게</option>
                </select>
                <div style="width:1px; background:var(--border-color); margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('bold')"><b>B</b></button>
                <button class="editor-btn" onclick="formatDoc('italic')"><i>I</i></button>
                <button class="editor-btn" onclick="formatDoc('underline')"><u>U</u></button>
                <button class="editor-btn" onclick="formatDoc('strikeThrough')"><s>S</s></button>
                <div style="width:1px; background:var(--border-color); margin:0 4px;"></div>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#333333')" style="color:#333;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#d32f2f')" style="color:#d32f2f;">A</button>
                <button class="editor-btn" onclick="formatDoc('foreColor', '#3b82f6')" style="color:#3b82f6;">A</button>
            </div>
            <div class="note-area-rich" id="mainNote" contenteditable="true" onfocus="insertDateTag(this)" placeholder="메모를 입력하세요..."></div>
        </div>

        <div class="card sp-card">
            <div class="section-title title-dark-blue">경건생활</div>
            <div class="sp-grid">
                <div class="sp-item"><span class="sp-label bg-green">실천</span><textarea class="sp-text" id="sp1" onfocus="insertDateTag(this)" placeholder="클릭시 날짜 입력됨"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-orange">반성</span><textarea class="sp-text" id="sp2" onfocus="insertDateTag(this)" placeholder="클릭시 날짜 입력됨"></textarea></div>
                <div class="sp-item"><span class="sp-label bg-purple">소망</span><textarea class="sp-text" id="sp3" onfocus="insertDateTag(this)" placeholder="클릭시 날짜 입력됨"></textarea></div>
            </div>
        </div>
        <div class="card sum-card">
            <div class="sum-grid">
                <div class="sum-item thanks"><span class="sum-label">THANKS</span><textarea class="sum-text" id="thanksText" onfocus="insertDateTag(this)" placeholder="오늘 감사한 점..."></textarea></div>
                <div class="sum-item summary"><span class="sum-label">SUMMARY</span><textarea class="sum-text" id="summaryText" onfocus="insertDateTag(this)" placeholder="오늘의 요약..."></textarea></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal & Context Menu -->
<div class="modal-overlay" id="resetModal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--text-main);">항목 지우기</h3>
        <div class="chk-list">
            <label><input type="checkbox" id="chkPri" checked> Top Priority</label>
            <label><input type="checkbox" id="chkTodo" checked> To Do List</label>
            <label><input type="checkbox" id="chkTime" checked> Time Line</label>
            <label><input type="checkbox" id="chkNote" checked> Note & Others</label>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px;">
            <button class="btn" style="background:var(--border-color); color:var(--text-main)" onclick="closeResetModal()">취소</button>
            <button class="btn btn-reset" onclick="executeReset()">삭제</button>
        </div>
    </div>
</div>

<div id="ctxMenu">
    <div id="ctxItemInsert" onclick="handleCtx('insert')">입력</div>
    <div id="ctxItemManual" onclick="handleCtx('manual')">수동입력</div> 
    <div id="ctxItemClear" onclick="handleCtx('clear')">지우기</div>
</div>

<div id="saveStatus">저장됨</div>

<!-- [복구됨] Firebase 모듈 임포트 및 로직 -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // [중요] 기존 파일에서 복구한 Firebase Config입니다.
    const firebaseConfig = {
        apiKey: "AIzaSyDNq4dpGtd7RPH6Gey9V4hH6FwdPkLEavs",
        authDomain: "mydashboard-ohc.firebaseapp.com",
        projectId: "mydashboard-ohc",
        storageBucket: "mydashboard-ohc.firebasestorage.app",
        messagingSenderId: "802535259250",
        appId: "1:802535259250:web:48f21568b7c735a2ec16eb",
        measurementId: "G-9NZGEZ4KBF"
    };

    let app, auth, db, currentUser;
    let unsubscribeSnapshot = null;
    let isRemoteUpdate = false; 

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) { console.error("Firebase Error", e); }

    window.googleLogin = () => {
        signInWithPopup(auth, new GoogleAuthProvider()).catch(err => alert("로그인 실패: " + err.message));
    };

    window.logout = () => {
        if(confirm("로그아웃 하시겠습니까?")) signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('btnLogout').style.display = 'block';
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            
            // 캘린더 업데이트
            if(user.email) {
                document.getElementById('calendarFrame').src = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(user.email)}&ctz=Asia%2FSeoul`;
            }

            // DB 리스너 연결
            unsubscribeSnapshot = onSnapshot(doc(db, "dashboards", user.uid), (docSnap) => {
                if (docSnap.exists()) {
                    isRemoteUpdate = true;
                    applyDataToUI(docSnap.data());
                    isRemoteUpdate = false;
                }
            });
        } else {
            currentUser = null;
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('btnLogout').style.display = 'none';
            document.getElementById('calendarFrame').src = "https://calendar.google.com/calendar/embed?src=en.south_korea%23holiday%40group.v.calendar.google.com&ctz=Asia%2FSeoul";
        }
    });

    let saveTimeout;
    window.triggerSave = () => {
        if(!currentUser || isRemoteUpdate) return;
        const status = document.getElementById('saveStatus');
        status.innerText = "저장 중...";
        status.style.opacity = 1;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveToCloud, 1000);
    };

    async function saveToCloud() {
        if(!currentUser) return;
        const data = collectDataFromUI();
        try {
            await setDoc(doc(db, "dashboards", currentUser.uid), data, { merge: true });
            const status = document.getElementById('saveStatus');
            status.innerText = "동기화 완료";
            setTimeout(()=> { status.style.opacity = 0; }, 2000);
        } catch (e) {
            console.error("Save Error:", e);
            document.getElementById('saveStatus').innerText = "저장 실패";
        }
    }

    window.appSave = window.triggerSave; 
    window.forceSave = saveToCloud; 
</script>

<script>
    // General UI Logic
    let ctxTarget = null;
    let ctxType = null;
    
    // 테마 설정
    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        
        // 아이콘 변경
        const btn = document.querySelector('.btn-theme i');
        btn.className = isDark ? 'fas fa-moon' : 'fas fa-sun';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 날짜 표시
        const now = new Date();
        document.getElementById('headerDate').innerText = now.toLocaleDateString('ko-KR', {
            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
        });

        // 테마 로드
        if(localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.querySelector('.btn-theme i').className = 'fas fa-sun';
        }

        // 초기 행 렌더링 (기본 10개)
        for(let i=0; i<10; i++) addTodoRow();
        for(let i=0; i<10; i++) addTimelineRow();

        // 이벤트 리스너
        document.body.addEventListener('input', (e) => { if(window.appSave) window.appSave(); });
        document.body.addEventListener('change', (e) => { if(window.appSave) window.appSave(); });
        
        // 우선순위 메뉴 닫기
        document.addEventListener('click', (e) => {
            const ctxMenu = document.getElementById('ctxMenu');
            if (ctxMenu) ctxMenu.style.display = 'none';
            if (!e.target.closest('.priority-wrap')) {
                document.querySelectorAll('.priority-menu').forEach(m => m.style.display = 'none');
            }
        });
    });

    // --- 자동 날짜 태그 입력 함수 ---
    function insertDateTag(el) {
        const now = new Date();
        const dateStr = `[${now.getMonth() + 1}/${now.getDate()}]`; 
        
        // ContentEditable (Note 섹션) 지원
        if (el.isContentEditable && el.tagName === 'DIV') {
            if (el.innerText.includes(dateStr)) return;
            
            const hasContent = el.innerText.trim().length > 0;
            const htmlToAdd = hasContent ? `<br><b>${dateStr}</b> ` : `<b>${dateStr}</b> `;
            
            el.insertAdjacentHTML('beforeend', htmlToAdd);

            try {
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(el);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            } catch(e) { console.log("Cursor move failed", e); }
        } 
        // 기존 Textarea 로직
        else {
            if (el.value.includes(dateStr)) return;
            const prefix = el.value.trim() ? '\n' : '';
            el.value += `${prefix}${dateStr} `;
        }
        
        el.scrollTop = el.scrollHeight;
        if(window.appSave) window.appSave();
    }

    // --- 동적 행 추가 기능 ---
    function addTodoRow(vals = {}) {
        const box = document.getElementById('todoBox');
        const div = document.createElement('div');
        div.className = 'todo-block';
        div.innerHTML = `
            <div class="todo-header">
                <input type="text" class="date-input t-start" placeholder="시작" readonly onclick="handleDateClick(this)" oncontextmenu="openCtx(event, this, 'reset-only')" value="${vals.s||''}">
                <input type="text" class="date-input t-end" placeholder="마침" readonly value="${vals.e||''}">
            </div>
            <div class="todo-body">
                <div class="todo-chk-wrap">
                    <input type="checkbox" class="todo-check" onchange="toggleTodo(this)" ${vals.c?'checked':''}>
                </div>
                <div class="priority-wrap" onclick="togglePrio(this)">
                    <div class="priority-current prio-${vals.p||'0'}" data-val="${vals.p||'0'}">${getPrioChar(vals.p||'0')}</div>
                    <div class="priority-menu">
                        <div class="priority-option prio-3" onclick="setPrio(event, this, '3')">업무</div>
                        <div class="priority-option prio-2" onclick="setPrio(event, this, '2')">개인</div>
                        <div class="priority-option prio-1" onclick="setPrio(event, this, '1')">교회</div>
                        <div class="priority-option prio-0" onclick="setPrio(event, this, '0')">기타</div>
                    </div>
                </div>
                <textarea class="todo-content ${vals.c?'completed':''}" placeholder="할 일 입력" ${vals.c?'readonly':''}>${vals.t||''}</textarea>
            </div>`;
        box.appendChild(div);
        updateTodoCount();
    }

    function addTimelineRow(vals = {}) {
        const box = document.getElementById('timelineBox');
        const div = document.createElement('div');
        div.className = 'timeline-block';
        div.innerHTML = `
            <div class="timeline-header">
                <input type="text" class="time-box tm-start ${vals.s?'filled':''}" placeholder="시작" readonly onclick="handleTimeClick(this)" oncontextmenu="openCtx(event, this, 'time-menu')" value="${vals.s||''}">
                <input type="text" class="time-box tm-end ${vals.e?'filled':''}" placeholder="마침" readonly onclick="handleTimeClick(this)" oncontextmenu="openCtx(event, this, 'time-menu')" value="${vals.e||''}">
            </div>
            <textarea class="timeline-text" placeholder="내용">${vals.t||''}</textarea>`;
        box.appendChild(div);
    }

    function updateTodoCount() {
        const total = document.querySelectorAll('.todo-block').length;
        document.getElementById('todoCount').innerText = `(${total})`;
    }

    // --- 데이터 처리 (수집/적용) ---
    function collectDataFromUI() {
        const priRows = Array.from(document.querySelectorAll('#priorityBox .priority-row'));
        
        return {
            pri: priRows.map(r => ({
                t: r.querySelector('textarea').value,
                c: r.querySelector('input[type="checkbox"]').checked
            })),
            todo: Array.from(document.querySelectorAll('.todo-block')).map(r => ({
                s: r.querySelector('.t-start').value,
                e: r.querySelector('.t-end').value,
                c: r.querySelector('.todo-check').checked,
                p: r.querySelector('.priority-current').getAttribute('data-val') || '0',
                t: r.querySelector('.todo-content').value
            })),
            line: Array.from(document.querySelectorAll('.timeline-block')).map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            })),
            note: document.getElementById('mainNote').innerHTML,
            sp: [document.getElementById('sp1').value, document.getElementById('sp2').value, document.getElementById('sp3').value],
            sum: [document.getElementById('thanksText').value, document.getElementById('summaryText').value]
        };
    }

    // [중요] applyDataToUI는 DB에서 가져온 데이터를 화면에 뿌리는 역할을 합니다.
    // 기존에 데이터가 있다면 행을 추가하여 보여줍니다.
    function applyDataToUI(d) {
        if(!d) return;
        
        // Priority
        const priRows = document.querySelectorAll('#priorityBox .priority-row');
        if(d.pri && Array.isArray(d.pri)) {
            d.pri.forEach((v, i) => {
                if(priRows[i]) {
                    const txt = typeof v === 'object' ? v.t : v;
                    const chk = typeof v === 'object' ? v.c : false;
                    priRows[i].querySelector('textarea').value = txt;
                    priRows[i].querySelector('input[type="checkbox"]').checked = chk;
                }
            });
        }

        // ToDo
        const todoBox = document.getElementById('todoBox');
        todoBox.innerHTML = '';
        if(d.todo && d.todo.length > 0) {
            d.todo.forEach(v => addTodoRow(v));
        } else {
            for(let i=0; i<10; i++) addTodoRow();
        }

        // Timeline
        const timeBox = document.getElementById('timelineBox');
        timeBox.innerHTML = '';
        if(d.line && d.line.length > 0) {
            d.line.forEach(v => addTimelineRow(v));
        } else {
            for(let i=0; i<10; i++) addTimelineRow();
        }

        // Note & Sp/Sum
        const noteDiv = document.getElementById('mainNote');
        if(d.note && noteDiv.innerHTML !== d.note && document.activeElement !== noteDiv) {
            noteDiv.innerHTML = d.note;
        }
        ['sp1','sp2','sp3'].forEach((id, i) => {
            const el = document.getElementById(id);
            if(d.sp && d.sp[i]) el.value = d.sp[i];
        });
        ['thanksText','summaryText'].forEach((id, i) => {
             const el = document.getElementById(id);
             if(d.sum && d.sum[i]) el.value = d.sum[i];
        });
    }

    // --- 유틸리티 함수들 ---
    function getPrioChar(val) {
        switch(val) {
            case '3': return '업';
            case '2': return '개';
            case '1': return '교';
            default: return '기';
        }
    }

    function getFormattedDateTime() {
        const now = new Date();
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const dd = now.getDate().toString().padStart(2, '0');
        const hh = now.getHours().toString().padStart(2, '0');
        const mi = now.getMinutes().toString().padStart(2, '0');
        return `${mm}월${dd}일 ${hh}:${mi}`;
    }

    function handleDateClick(el) { el.value = getFormattedDateTime(); if(window.appSave) window.appSave(); }
    function handleTimeClick(el) { el.value = getFormattedDateTime(); el.classList.add('filled'); if(window.appSave) window.appSave(); }
    
    function toggleTodo(chk) {
        const block = chk.closest('.todo-block');
        const end = block.querySelector('.t-end');
        const txt = block.querySelector('.todo-content');
        if(chk.checked) {
            end.value = getFormattedDateTime();
            txt.classList.add('completed');
            txt.readOnly = true;
        } else {
            end.value = '';
            txt.classList.remove('completed');
            txt.readOnly = false;
        }
        if(window.appSave) window.appSave();
    }

    function togglePrio(wrapper) {
        const menu = wrapper.querySelector('.priority-menu');
        document.querySelectorAll('.priority-menu').forEach(m => {
            if(m !== menu) m.style.display = 'none';
        });
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    function setPrio(e, el, val) {
        e.stopPropagation();
        const wrapper = el.closest('.priority-wrap');
        const current = wrapper.querySelector('.priority-current');
        current.setAttribute('data-val', val);
        current.className = `priority-current prio-${val}`;
        current.innerText = getPrioChar(val);
        wrapper.querySelector('.priority-menu').style.display = 'none';
        if(window.appSave) window.appSave();
    }

    function formatDoc(cmd, value=null) {
        document.execCommand(cmd, false, value);
        document.getElementById('mainNote').focus();
        if(window.appSave) window.appSave();
    }

    // Context Menu Logic
    function openCtx(e, el, type) {
        e.preventDefault();
        ctxTarget = el;
        ctxType = type;
        const menu = document.getElementById('ctxMenu');
        const itemInsert = document.getElementById('ctxItemInsert');
        const itemManual = document.getElementById('ctxItemManual');
        const itemClear = document.getElementById('ctxItemClear');

        itemInsert.style.display = (type === 'reset-only' || type === 'time-menu') ? 'none' : 'block';
        itemManual.style.display = (type === 'time-menu') ? 'block' : 'none';
        itemClear.innerText = (type === 'reset-only' || type === 'time-menu') ? '초기화' : '지우기';

        if(type !== 'reset-only' && type !== 'time-menu') itemInsert.innerText = "현재 시간 입력";

        menu.style.display = 'block';
        menu.style.left = Math.min(e.pageX, window.innerWidth - 120) + 'px';
        menu.style.top = e.pageY + 'px';
    }

    function handleCtx(action) {
        if(!ctxTarget) return;
        if (action === 'manual') {
            const input = prompt("시간 입력 (예: 1430)");
            if (input) {
                const nums = input.replace(/[^0-9]/g, '');
                if (nums.length >= 3) {
                    const h = nums.length===3 ? nums.slice(0,1) : nums.slice(0,2);
                    const m = nums.length===3 ? nums.slice(1) : nums.slice(2);
                    ctxTarget.value = `${h}시 ${m}분`;
                    ctxTarget.classList.add('filled');
                }
            }
        } else if (action === 'insert') {
            ctxTarget.value = getFormattedDateTime();
        } else {
            ctxTarget.value = '';
            ctxTarget.classList.remove('filled');
        }
        if(window.appSave) window.appSave();
        document.getElementById('ctxMenu').style.display = 'none';
    }

    // Export logic
    function openResetModal() { document.getElementById('resetModal').style.display='flex'; }
    function closeResetModal() { document.getElementById('resetModal').style.display='none'; }
    function executeReset() {
        if(document.getElementById('chkPri').checked) {
            document.querySelectorAll('#priorityBox .priority-row').forEach(r => {
                r.querySelector('textarea').value = '';
                r.querySelector('input[type="checkbox"]').checked = false;
            });
        }
        if(document.getElementById('chkTodo').checked) {
            document.getElementById('todoBox').innerHTML = '';
            for(let i=0; i<10; i++) addTodoRow();
        }
        if(document.getElementById('chkTime').checked) {
            document.getElementById('timelineBox').innerHTML = '';
            for(let i=0; i<10; i++) addTimelineRow();
        }
        if(document.getElementById('chkNote').checked) {
            document.getElementById('mainNote').innerHTML = '';
            ['sp1','sp2','sp3','thanksText','summaryText'].forEach(id=>document.getElementById(id).value='');
        }
        if(window.appSave) window.appSave();
        closeResetModal();
    }
    
    function exportData() {
        const scriptURL = "https://script.google.com/macros/s/AKfycbxX3gDWPWkeL4F6A7LVnyH1Ti6QueDJLjbDzO4e2ro4_nNkaX9JQc5m2JNNRNZM53je/exec"; 
        if(!confirm("체크된 항목을 내보내시겠습니까?")) return;
        
        // Export Logic 복구 (V11 참고)
        const btn = document.querySelector('.btn-export');
        const originalText = btn.innerText;
        btn.innerText = "전송 중...";

        const getPrioShape = (val) => {
            if(val === '3') return '★';
            if(val === '2') return '■';
            if(val === '1') return '●';
            return '○';
        };

        const priRows = Array.from(document.querySelectorAll('#priorityBox .priority-row'));
        const exportPri = priRows
            .filter(r => r.querySelector('input[type="checkbox"]').checked)
            .map(r => r.querySelector('textarea').value);
        
        // 데이터 수집
        const allBlockEls = Array.from(document.querySelectorAll('.todo-block'));
        const allTodosRaw = allBlockEls.map(r => ({
            s: r.querySelector('.t-start').value,
            e: r.querySelector('.t-end').value,
            c: r.querySelector('.todo-check').checked,
            p_val: r.querySelector('.priority-current').getAttribute('data-val') || '0', 
            t: r.querySelector('.todo-content').value
        }));

        const exportTodos = allTodosRaw
            .filter(t => t.c === true)
            .map(t => ({
                s: t.s,
                e: t.e,
                c: t.c,
                p: getPrioShape(t.p_val), 
                t: t.t
            }));

        const timelineData = Array.from(document.querySelectorAll('.timeline-block'))
            .map(b => ({
                s: b.querySelector('.tm-start').value,
                e: b.querySelector('.tm-end').value,
                t: b.querySelector('.timeline-text').value
            }))
            .filter(l => l.t.trim() !== ""); 

        const payload = {
            pri: exportPri, 
            todo: exportTodos, 
            line: timelineData, 
            note: document.getElementById('mainNote').innerText,
            sp: [
                document.getElementById('sp1').value, 
                document.getElementById('sp2').value, 
                document.getElementById('sp3').value
            ],
            sum: [
                document.getElementById('thanksText').value, 
                document.getElementById('summaryText').value
            ]
        };

        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success') {
                alert("성공적으로 저장되었습니다!");
                // 성공 후 정리 로직은 사용자 선택에 맡기거나 여기 추가
            } else {
                alert("전송 실패: " + data.error);
            }
        })
        .catch(error => {
            console.error('Export Error:', error);
            alert("전송 요청 완료! (데이터가 시트에 들어갔는지 확인하세요)");
        })
        .finally(() => {
            btn.innerText = originalText;
        });
    }
</script>
</body>
</html>
